<!doctype html><html><head><title>Operations :: Lucid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2020-11-04T22:21:45 UTC"><meta name=description content><title>Operations :: Lucid</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/layout.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.main.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.menu.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/site.webmanifest><script async defer src=https://buttons.github.io/buttons.js></script></head><body data-url=/operations/ class=hideheader><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><script type=text/javascript src=/js/search.js></script></div><div style=margin-top:30px><a href=/introduction style=display:flex;justify-content:left;align-items:center><img src=/icon/lucid-icon.svg width=100 height=100 style=margin-left:15px><h2 style=margin-top:-14px>Lucid</h2></a></div><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><li data-nav-id=https://docs.lucidarch.dev/introduction/ class="dd-item
alwaysopen
item_level_$level"><a href=/introduction/>Introduction</a></li><li data-nav-id=https://docs.lucidarch.dev/philosophy/ class="dd-item
alwaysopen
item_level_$level"><a href=/philosophy/>Philosophy</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/routing/ class="dd-item
alwaysopen
item_level_$level"><a href=/routing/>Routing</a></li><li data-nav-id=https://docs.lucidarch.dev/controllers/ class="dd-item
alwaysopen
item_level_$level"><a href=/controllers/>Controllers</a></li><li data-nav-id=https://docs.lucidarch.dev/features/ class="dd-item
alwaysopen
item_level_$level"><a href=/features/>Features</a></li><li data-nav-id=https://docs.lucidarch.dev/jobs/ class="dd-item
alwaysopen
item_level_$level"><a href=/jobs/>Jobs</a></li><li data-nav-id=https://docs.lucidarch.dev/operations/ class="dd-item parent active
alwaysopen
item_level_$level"><a href=/operations/>Operations</a></li><li data-nav-id=https://docs.lucidarch.dev/validation/ class="dd-item
alwaysopen
item_level_$level"><a href=/validation/>Validation</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/cli/ class="dd-item
alwaysopen
item_level_$level"><a href=/cli/>CLI Reference</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://docs.lucidarch.dev>Home</a></li><li class=active>Operations</li></ol></nav><h1>Operations</h1><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#generate-operation-class>Generate Operation Class</a></li><li><a href=#calling-operations>Calling Operations</a></li><li><a href=#queueable-operations>Queueable Operations</a><ul><li><a href=#generate-queueable-operation>Generate Queueable Operation</a></li><li><a href=#specify-queue-name>Specify Queue Name</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#mocking-jobs>Mocking Jobs</a></li></ul></li></ul></nav></div><div class=content><p>Their purpose is to increase the degree of code reusability by piecing jobs together to provide composite functionalities from across domains.</p><hr><p>Operations are a group of jobs that deliver multi-step functionalities.
Technically, Operation classes are similar to Feature classes in usage; meaning that they both have
<code>run($job,$params)</code> in common to run jobs from any domain, and can be called standalone (e.g. call an operation from a Command).</p><p>However, conceptually they have their differences in that a Feature can run multiple Operation and Job classes while an Operation can run multiple Jobs only.
They also differ in what they represent to the application: A feature is what the application provides to the outside, while an operation is more of an internal aspect. Technically they differ in they way they are dispatched, where we <code>serve</code> a feature but we <code>run</code> an operation;
any class can do so the same as a Feature class would by turning it into a <a href=https://docs.lucidarch.dev/jobs/#custom-dispatcher title="Custom Dispatcher">dispatcher class</a>.</p><p><strong>Example</strong></p><p>Given that we are working on a publishing platform, and upon creating an article we would like to send notifications to the subscribers
of the author, here&rsquo;s what that operation may look like:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>NotifySubscribersOperation</span> <span class=k>extends</span> <span class=nx>Operation</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>int</span> <span class=nv>$authorId</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$authorId</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>authorId</span> <span class=o>=</span> <span class=nv>$authorId</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Sends notifications to subscribers.
</span><span class=sd>     *
</span><span class=sd>     * @return int Number of notification jobs enqueued.
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>int</span>
    <span class=p>{</span>
        <span class=nv>$author</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>GetAuthorByIDJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>authorId</span><span class=p>,</span>
        <span class=p>]);</span>

        <span class=k>do</span> <span class=p>{</span>

            <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>PaginateSubscribersJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
                <span class=s1>&#39;authorId&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>authorId</span><span class=p>,</span>
            <span class=p>]);</span>

            <span class=k>if</span> <span class=p>(</span><span class=nv>$result</span><span class=o>-&gt;</span><span class=na>subscribers</span><span class=o>-&gt;</span><span class=na>isNotEmpty</span><span class=p>())</span> <span class=p>{</span>
                <span class=c1>// it&#39;s a queueable job so it will be enqueued, no waiting time
</span><span class=c1></span>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SendNotificationJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
                    <span class=s1>&#39;from&#39;</span> <span class=o>=&gt;</span> <span class=nv>$author</span><span class=p>,</span>
                    <span class=s1>&#39;to&#39;</span> <span class=o>=&gt;</span> <span class=nv>$result</span><span class=o>-&gt;</span><span class=na>subscribers</span><span class=p>,</span>
                    <span class=s1>&#39;notification&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;article.published&#39;</span><span class=p>,</span>
                <span class=p>]);</span>
            <span class=p>}</span>

        <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=nv>$result</span><span class=o>-&gt;</span><span class=na>hasMorePages</span><span class=p>());</span>

        <span class=k>return</span> <span class=nv>$result</span><span class=o>-&gt;</span><span class=na>total</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>As you see the jobs that are used in this operation are ones that can be shared with other areas in our code as well,
increasing the degree of reusable code.</p><ol><li><p><code>GetAuthorByIDJob</code>: to retrieve a user/author by ID is as abstract as it can get, and will definitely be used numerous times in our application.</p></li><li><p><code>PaginateSubscribersJob</code>: would be used every time we need to retrieve an author&rsquo;s subscribers. Such jobs usually grow in responsibility over time
and their results become more customizable.</p><p><em>Example: later it may allow to specify a certain limit to the number of subscribers to return,
then we&rsquo;d be able to paginate them for listing subscribers in a view or over an API.</em></p></li><li><p><code>SendNotificationJob</code>: will be used every time we need to send a notification, regardless of the type of notification to be sent
since it is specified with the <code>notification</code> parameter. Which also can grow into providing more customization such as specifying
the type of notification to send (e.g. mobile, browser, web, email etc.).</p></li></ol><p>With this we&rsquo;ve achieved <strong>single responsibility</strong> at a <strong>low cost of debt</strong> and <strong>prepared for scale</strong>. In fact,
some of these jobs would&rsquo;ve been implemented already by the time we reached this operation which makes it <strong>quick to biuld</strong>.</p><p>Now we have that functionality bundled at our disposal to be called whenever needed:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>NotifySubscribersOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;authorId&#39;</span> <span class=o>=&gt;</span> <span class=nv>$authorId</span><span class=p>,</span>
<span class=p>]);</span>
</code></pre></div><h2 ref=generate-operation-class>Generate Operation Class</h2><a class=anchor id=generate-operation-class></a><p>Use <code>lucid</code> CLI to generate an Operation class that extends Lucid&rsquo;s Operation base class by default, which <code>handle</code> method is invoked when run by a Feature or a custom dispatcher.</p><div class=tabs><input type=radio name=tabs-1 id=tabs-1-0 checked>
<label for=tabs-1-0>Micro</label><div class=tab><p><strong>Signature</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation &lt;operation&gt; <span class=o>{</span>--Q<span class=p>|</span>queue<span class=o>}</span>
</code></pre></div><p><strong>Example</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation NotifySubscribers
</code></pre></div><p>Generated class will be at <code>app/Operations/NotifySubscribersOperation.php</code></p><p>and its test at <code>tests/Operations/NotifySubscribersOperationTest.php</code></p></div><input type=radio name=tabs-1 id=tabs-1-1>
<label for=tabs-1-1>Monolith</label><div class=tab><p><strong>Signature</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation &lt;operation&gt; &lt;service&gt; <span class=o>{</span>--Q<span class=p>|</span>queue<span class=o>}</span>
</code></pre></div><p><strong>Example</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation NotifySubscribers publishing
</code></pre></div><p>Generated class will be at <code>src/Services/Publishing/Operations/NotifySubscribersOperation.php</code></p><p>and its test at <code>src/Services/Publishing/Tests/Operations/NotifySubscribersOperationTest.php</code></p></div></div><p>The generated Operation class will automatically be suffixed with <code>Operation</code>, so there&rsquo;s no need for it to be specified in the command.</p><h2 ref=calling-operations>Calling Operations</h2><a class=anchor id=calling-operations></a><p>Similar to jobs, and Operation can also be called using the <code>run</code> method that&rsquo;s provided by extending one Lucid&rsquo;s <code>Feature</code> or a <a href=/jobs/#custom-dispatcher>custom dispatcher</a>,</p><p>See <a href=https://docs.lucidarch.dev/jobs/#calling-jobs>here</a> for more on the <code>run</code> method.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>PublishArticleFeature</span> <span class=k>extends</span> <span class=nx>Feature</span>
<span class=p>{</span>
   <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>ValidateArticlePublishingInputJob</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>()));</span>

   <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SetArticlePublishingRulesOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>),</span>
        <span class=s1>&#39;schedule&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;datetime&#39;</span><span class=p>),</span>
        <span class=s1>&#39;platforms&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;platforms&#39;</span><span class=p>),</span>
        <span class=s1>&#39;visibility&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;visibility&#39;</span><span class=p>),</span>
   <span class=p>]);</span>

   <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>NotifySubscribersOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;authorId&#39;</span> <span class=o>=&gt;</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>id</span><span class=p>(),</span>
   <span class=p>]);</span>

   <span class=nv>$article</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>GetArticleByIDJob</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)));</span>

   <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithViewJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=nx>compact</span><span class=p>(</span><span class=s1>&#39;article&#39;</span><span class=p>),</span>
        <span class=s1>&#39;template&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;articles.publish.success&#39;</span><span class=p>,</span>
   <span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><h2 ref=queueable-operations>Queueable Operations</h2><a class=anchor id=queueable-operations></a><p>You may turn any operation into a queueable operation that will be dispatched using <a href=laravel.com/docs/queues>Laravel Queues</a>
rather than running synchronously, by simply implementing <code>ShouldQueue</code> interface.</p><h3 ref=generate-queueable-operation>Generate Queueable Operation</h3><a class=anchor id=generate-queueable-operation></a><p>Use the <code>--queue</code> or shorthand <code>-Q</code> to generate a queueable operation.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job NotifySubscribers --queue
</code></pre></div><p>Will produce the following operation class:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>NotifySubscribersOperation</span> <span class=k>extends</span> <span class=nx>Operation</span> <span class=k>implements</span> <span class=nx>ShouldQueue</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=c1>// notifications processing will happen in the queue
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>This job will be treated exactly as Laravel treats <a href=https://laravel.com/docs/queues#class-structure>queued jobs</a>.</p><h3 ref=specify-queue-name>Specify Queue Name</h3><a class=anchor id=specify-queue-name></a><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>()</span>
<span class=p>{</span>
    <span class=cm>/*
</span><span class=cm>     * set the name of the queue on which to dispatch this operation.
</span><span class=cm>     * if using Horizon, this should be the same as the one configured there.
</span><span class=cm>     */</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>onQueue</span><span class=p>(</span><span class=s1>&#39;notifications&#39;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h2 ref=testing>Testing</h2><a class=anchor id=testing></a><p>When generating an operation with <code>lucid make:operation</code> a test class is automatically generated along, having <code>markIncomplete()</code> statement in a stub method as a reminder to fill the missing test.</p><div class=tabs><input type=radio name=tabs-3 id=tabs-3-0 checked>
<label for=tabs-3-0>Micro</label><div class=tab><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation NotifySubscribers
</code></pre></div><p>Would generate two files:</p><ul><li><code>app/Operations/NotifySubscribersOperation.php</code></li><li><code>tests/Operations/NotifySubscribersOperationTest.php</code></li></ul></div><input type=radio name=tabs-3 id=tabs-3-1>
<label for=tabs-3-1>Monolith</label><div class=tab><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation NotifySubscribers publishing
</code></pre></div><p>Would generate two files:</p><ul><li><code>src/Services/Publishing/Operations/NotifySubscribersOperation.php</code></li><li><code>src/Services/Publishing/Tests/Operations/NotifySubscribersOperationTest.php</code></li></ul></div></div><p>The purpose of operation testing is to ensure that the integration between the jobs it runs is working as expected,
but we do not have to test every job&rsquo;s case on its own, for that we rely on jobs being tested for their integrity.</p><p>For example, consider the following operation test:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Publishing\Tests\Operations</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Author</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Subscriber</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Queue</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Services\Operations\NotifySubscribersOperation</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>NotifySubscribersOperationTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_successfully_notifying_subscribers</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=c1>// SendNotificationJob will be dispatched to the queue
</span><span class=c1></span>        <span class=nx>Queue</span><span class=o>::</span><span class=na>fake</span><span class=p>();</span>

        <span class=c1>// queue must be empty
</span><span class=c1></span>        <span class=nx>Queue</span><span class=o>::</span><span class=na>assertNothingPushed</span><span class=p>();</span>

        <span class=c1>// n. of subscribers we&#39;re testing with
</span><span class=c1></span>        <span class=nv>$subscribers</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

        <span class=nv>$author</span> <span class=o>=</span> <span class=nx>Author</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span>
            <span class=o>-&gt;</span><span class=na>has</span><span class=p>(</span><span class=nx>Subscriber</span><span class=o>::</span><span class=na>factory</span><span class=p>(</span><span class=nv>$subscribers</span><span class=p>));</span>
            <span class=o>-&gt;</span><span class=na>create</span><span class=p>();</span>

        <span class=nv>$op</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>NotifySubscribersOperation</span><span class=p>(</span><span class=nv>$author</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>);</span>
        <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$op</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=c1>// assert all subscribers were paginated
</span><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=nv>$subscribers</span><span class=p>,</span> <span class=nv>$result</span><span class=p>);</span>

        <span class=c1>// assert the correct n. of SendNotificationJob were dispatched
</span><span class=c1></span>        <span class=nx>Queue</span><span class=o>::</span><span class=na>assertPushed</span><span class=p>(</span><span class=nx>SendNotificationJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$subscribers</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 ref=mocking-jobs>Mocking Jobs</h3><a class=anchor id=mocking-jobs></a><p>When testing, you may occasionally need to skip dispatching a certain job but would still want to make sure that the operation
actually ran the job as expected, with the correct parameters.
In such cases we would mock the operation&rsquo;s <code>run</code> <a href=http://docs.mockery.io/en/latest/reference/partial_mocks.html title="Partial Mocks">partially</a>.</p><p>In our case we&rsquo;d update our test to not dispatch <code>SendNotificationJob</code> so that we don&rsquo;t actually send notifications.
This may seem odd at first because we are mocking the class that we are actually testing,
but <strong>with partial mocks only the methods that we set expectations on would be mocked and the rest would be dispatched.</strong>
And in case the operation doesn&rsquo;t call <code>run(SendNotificationJob::class, $params)</code> with the expected parameters the test will fail.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Publishing\Tests\Operations</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Mockery</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Author</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Subscriber</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Services\Operations\NotifySubscribersOperation</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>NotifySubscribersOperationTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_successfully_notifying_subscribers_with_mock</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=c1>// n. of subscribers we&#39;re testing with
</span><span class=c1></span>        <span class=nv>$subscribers</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>

        <span class=nv>$author</span> <span class=o>=</span> <span class=nx>Author</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span>
            <span class=o>-&gt;</span><span class=na>has</span><span class=p>(</span><span class=nx>Subscriber</span><span class=o>::</span><span class=na>factory</span><span class=p>(</span><span class=nv>$subscribers</span><span class=p>));</span>
            <span class=o>-&gt;</span><span class=na>create</span><span class=p>();</span>

        <span class=c1>// create operation mock instance
</span><span class=c1></span>        <span class=nv>$mOp</span> <span class=o>=</span> <span class=nx>Mockery</span><span class=o>::</span><span class=na>mock</span><span class=p>(</span><span class=nx>NotifySubscribersOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span><span class=nv>$author</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>]);</span>

        <span class=c1>// set expectations to jobs that need to be skipped
</span><span class=c1></span>        <span class=nv>$mOp</span><span class=o>-&gt;</span><span class=na>shouldReceive</span><span class=p>(</span><span class=s1>&#39;run&#39;</span><span class=p>)</span>
            <span class=o>-&gt;</span><span class=na>with</span><span class=p>(</span><span class=nx>SendNotificationJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
                <span class=s1>&#39;from&#39;</span> <span class=o>=&gt;</span> <span class=nv>$author</span><span class=p>,</span>
                <span class=s1>&#39;to&#39;</span> <span class=o>=&gt;</span> <span class=nv>$author</span><span class=o>-&gt;</span><span class=na>subscribers</span><span class=p>,</span>
                <span class=s1>&#39;notification&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;article.published&#39;</span><span class=p>,</span>
            <span class=p>]);</span>

        <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$mOp</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=c1>// assert all subscribers were paginated
</span><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=nv>$subscribers</span><span class=p>,</span> <span class=nv>$result</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Whether to mock or not is a case-by-case decision, but as a general guideline it is best to always test with what&rsquo;s closest to reality.</p></div><div class=chevrons><a class=next href=/validation/ title=Validation style=margin-right:0><div><p>Next page</p><label>Validation</label></div><i class="fas fa-arrow-right" style=font-size:1.7em></i></a></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/operations/>Operations</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#generate-operation-class>Generate Operation Class</a></li><li><a href=#calling-operations>Calling Operations</a></li><li><a href=#queueable-operations>Queueable Operations</a><ul><li><a href=#generate-queueable-operation>Generate Queueable Operation</a></li><li><a href=#specify-queue-name>Specify Queue Name</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#mocking-jobs>Mocking Jobs</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><i class="fas fa-calendar"></i>Last update on 20 October 2020</li></ul></nav></div></section></article><footer><div class=columns><div class=column><h3 style=color:#fdfdfd!important>Lucid Architecture</h3>for scalable software.</div><div class=column><div style=display:flex;justify-content:flex-end;align-items:center><div><a href=https://github.com/lucid-architecture target=_blank><i class="fab fa-github fa-lg"></i></a><a href=https://lucid-slack.herokuapp.com target=_blank style=margin-left:10px><i class="fab fa-slack fa-lg"></i></a><a href=https://www.reddit.com/r/LucidArchitecture/ target=_blank style=margin-left:10px><i class="fab fa-reddit-alien fa-lg"></i></a></div><div style=margin-left:50px;margin-top:6px><a class=github-button href=https://github.com/sponsors/lucid-architecture data-icon=octicon-heart aria-label="Sponsor @lucid-architecture on GitHub">Sponsor</a>
<a class=github-button href=https://github.com/ntkme/github-buttons data-icon=octicon-star data-show-count=true aria-label="Star ntkme/github-buttons on GitHub">Star</a></div></div></div></div></footer></body></html>