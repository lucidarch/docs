<!doctype html><html><head><title>Monolith :: Lucid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2020-12-04T09:40:53 UTC"><meta name=description content><title>Monolith :: Lucid</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/layout.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.main.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.menu.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-96232175-1','auto');ga('send','pageview');}</script><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/site.webmanifest><script async defer src=https://buttons.github.io/buttons.js></script></head><body data-url=/getting-started/monolith/ class=hideheader><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><script type=text/javascript src=/js/search.js></script></div><div style=margin-top:30px><a href=/concept style=display:flex;justify-content:left;align-items:center><img src=/icon/logo.png width=250 style=margin-left:10px></a></div><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><li data-nav-id=https://docs.lucidarch.dev/concept/ class="dd-item
alwaysopen
item_level_$level"><a href=/concept/>Concept</a></li><li data-nav-id=https://docs.lucidarch.dev/philosophy/ class="dd-item
alwaysopen
item_level_$level"><a href=/philosophy/>Philosophy</a></li><li data-nav-id=https://docs.lucidarch.dev/principles/ class="dd-item
alwaysopen
item_level_$level"><a href=/principles/>Principles</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/installation/ class="dd-item
alwaysopen
item_level_$level"><a href=/installation/>Installation</a></li><li data-nav-id=https://docs.lucidarch.dev/getting-started/ class="dd-item parent active
alwaysopen
item_level_$level"><a href=/getting-started/>Getting Started</a></li><li data-nav-id=https://docs.lucidarch.dev/micro-vs-monolith/ class="dd-item
alwaysopen
item_level_$level"><a href=/micro-vs-monolith/>Micro • Monolith</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/routing/ class="dd-item
alwaysopen
item_level_$level"><a href=/routing/>Routing</a></li><li data-nav-id=https://docs.lucidarch.dev/controllers/ class="dd-item
alwaysopen
item_level_$level"><a href=/controllers/>Controllers</a></li><li data-nav-id=https://docs.lucidarch.dev/features/ class="dd-item
alwaysopen
item_level_$level"><a href=/features/>Features</a></li><li data-nav-id=https://docs.lucidarch.dev/jobs/ class="dd-item
alwaysopen
item_level_$level"><a href=/jobs/>Jobs</a></li><li data-nav-id=https://docs.lucidarch.dev/operations/ class="dd-item
alwaysopen
item_level_$level"><a href=/operations/>Operations</a></li><li data-nav-id=https://docs.lucidarch.dev/services/ class="dd-item
alwaysopen
item_level_$level"><a href=/services/>Services</a></li><li data-nav-id=https://docs.lucidarch.dev/domains/ class="dd-item
alwaysopen
item_level_$level"><a href=/domains/>Domains</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/validation/ class="dd-item
alwaysopen
item_level_$level"><a href=/validation/>Validation</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/cli/ class="dd-item
alwaysopen
item_level_$level"><a href=/cli/>CLI Reference</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://docs.lucidarch.dev>Home</a></li><li><a class=text-link href=/getting-started/>Getting Started</a></li><li class=active>Monolith</li></ol></nav><h1>Getting Started<span>Monolith</span></h1><nav class=subpages><li><a title=$pagetitle href=/getting-started/micro/>Micro</a></li><li class=active><a title=$pagetitle href=/getting-started/monolith/>Monolith</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#setup>Setup</a><ul><li><a href=#install-laravel>Install Laravel</a></li><li><a href=#install-lucid>Install Lucid</a></li><li><a href=#database-configuration>Database Configuration</a></li></ul></li><li><a href=#initialize-monolith>Initialize Monolith</a></li><li><a href=#service-directory-structure>Service Directory Structure</a><ul><li><a href=#the-service-provider>The Service Provider</a></li></ul></li><li><a href=#authentication>Authentication</a></li><li><a href=#recipe-submission>Recipe Submission</a><ul><li><a href=#view>View</a></li><li><a href=#controller>Controller</a></li><li><a href=#feature>Feature</a></li><li><a href=#database>Database</a></li><li><a href=#model>Model</a></li><li><a href=#request-validation>Request Validation</a></li><li><a href=#calculate-recipe-price>Calculate Recipe Price</a></li><li><a href=#save-recipes>Save Recipes</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#configure-phpunit>Configure PHPUnit</a></li><li><a href=#unit-tests>Unit Tests</a></li><li><a href=#feature-test>Feature Test</a></li></ul></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#highlights>Highlights</a></li></ul></li></ul></nav></div><div class=content><div class="notices light"><p><i class="fab fa-github fa-lg"></i> The source code for this exercise is on <a href=https://github.com/lucidarch/getting-started-monolith>GitHub</a>.</p></div><p>In this guide we&rsquo;re going to build an application to share and discuss food recipes that&rsquo;s made up of two sections:</p><ol><li><strong>Kitchen</strong>: To manage and share recipes, calculating calories and avg. price.</li><li><strong>Forum</strong>: To discuss recipes with fellow members and get in touch with the experts.</li></ol><p>The purpose of this exercise is to demonstrate Lucid Monolith - the multi-purpose, service-oriented variant of Lucid.
Typically used when you wish to apply separation of concerns yet still be able to share code that is necessary for all
the parts such as models and business logic.</p><p>The obvious use of Monolith is to contain a large feature set within a single codebase, in contrast with Microservices
where we would dissect it into several codebases and have them responsible for their own part in isolation yet integrate
and communicate to get a single job done. Starting with Lucid&rsquo;s Monolith grants the ability to later do the transformation, making
it easier to decide on the different parts that need to go into their own [micro]services, and the code would&rsquo;ve already been
concentrated to minimise the move on their own.</p><div class="notices secondary"><p><i class="fas fa-archway"></i> For Micro - the single-purpose variant, see <a href=https://docs.lucidarch.dev/getting-started/micro/>Getting Started • Micro</a></p></div><h2 ref=setup>Setup</h2><a class=anchor id=setup></a><h3 ref=install-laravel>Install Laravel</h3><a class=anchor id=install-laravel></a><p>Let&rsquo;s start by creating a new Laravel project. It is best if you refer to <a href=https://laravel.com/docs/installation>Laravel&rsquo;s installation docs</a>
and choose your preferred way of installation, but here are the common ways to do it:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># via the installer</span>
laravel new cookery

<span class=c1># via composer</span>
composer create-project --prefer-dist laravel/laravel cookery
</code></pre></div><h3 ref=install-lucid>Install Lucid</h3><a class=anchor id=install-lucid></a><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>composer require lucidarch/lucid
</code></pre></div><h3 ref=database-configuration>Database Configuration</h3><a class=anchor id=database-configuration></a><p>Now that we have our project ready with a <code>.env</code> file we can configure the database connection.</p><p>For the brevity of this example
we will utilise SQLite as it requires the least steps to get going. This is surely not recommended in real apps
but will make very little difference since you can change the configuration and use your favourite database
without affecting the code.</p><ol><li><p>Create database file <code>storage/app/database/database.sql</code></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p storage/app/database <span class=o>&amp;&amp;</span> touch storage/app/database/database.sql
</code></pre></div></li><li><p>Configure database
<code>.env</code></p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=na>DB_CONNECTION</span><span class=o>=</span><span class=s>sqlite</span>
<span class=na>DB_DATABASE</span><span class=o>=</span><span class=s>{ABSOLUTE PATH}/storage/app/database/database.sql</span>
</code></pre></div></li><li><p>Create tables</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>php artisan migrate
</code></pre></div><p>And the output should match this:</p><pre><code>Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (4.11ms)
Migrating: 2014_10_12_100000_create_password_resets_table
Migrated:  2014_10_12_100000_create_password_resets_table (2.14ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (2.54ms)
</code></pre></li></ol><hr><h2 ref=initialize-monolith>Initialize Monolith</h2><a class=anchor id=initialize-monolith></a><p>Assuming that you have <code>./vendor/bin</code> in your <code>PATH</code> the <code>lucid</code> binary will be available to run <a href=https://docs.lucidarch.dev/cli/>Lucid commands</a>.</p><p>We will start with <code>init:monolith</code> to initialize directory structure and specify our first service to be created along.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid init:monolith Kitchen
</code></pre></div><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=l>Initializing Lucid Monolith for Laravel 8.15.0</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>Created directories</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=l>/app/Data</span><span class=w>
</span><span class=w></span><span class=l>/app/Domains</span><span class=w>
</span><span class=w></span><span class=l>/app/Services</span><span class=w>
</span><span class=w></span><span class=l>/app/Foundation</span><span class=w>
</span><span class=w></span><span class=l>/app/Policies</span><span class=w>
</span><span class=w></span><span class=l>Service Kitchen created successfully.</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=l>Activate it by adding App\Services\Kitchen\Providers\KitchenServiceProvider::class</span><span class=w>
</span><span class=w></span><span class=l>to &#39;providers&#39; in config/app.php</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s do as instructed and add the service&rsquo;s provider to the <code>providers</code> array in <code>config/app.php</code> and this way Laravel will recognize our Kitchen
service and load its files.</p><p>Now if we run our application with <code>php artisan serve</code> and visit <code>/kitchen</code> we should be greeted by the service.
By default the service&rsquo;s routes are prefixed with its name. Of course, you may modify that at <code>app/Services/Kitchen/routes</code>
which has the exact same structure as Laravel&rsquo;s default <code>/routes</code>.</p><h2 ref=service-directory-structure>Service Directory Structure</h2><a class=anchor id=service-directory-structure></a><p>Below is the default directory structure of every service in the monolith. They look familiar because they are the same as Laravel&rsquo;s
default structure, intended to provide the same functionality but with a different arrangement.</p><p>The highlighted directories are those that are proprietary to Lucid as we will learn throughout this guide.</p><pre>
app/Services/Kitchen
├── Console
│   └── Commands
├── <strong>Features</strong>
├── <strong>Operations</strong>
├── Http
│   ├── Controllers
│   └── Middleware
├── Providers
│   ├── ApiServiceProvider.php
│   ├── BroadcastServiceProvider.php
│   └── RouteServiceProvider.php
├── <strong>Tests</strong>
│   └── <strong>Features</strong>
│   └── <strong>Operations</strong>
├── database
│   ├── factories
│   ├── migrations
│   └── seeds
├── resources
│   ├── lang
│   └── views
└── routes
    ├── api.php
    ├── channels.php
    ├── console.php
    └── web.php
</pre><h3 ref=the-service-provider>The Service Provider</h3><a class=anchor id=the-service-provider></a><p><code>KitchenServiceProvider</code> is where the service tells Laravel how to locate its files such as routes, views, lang
and it may be used for anything that the service may need in the future. Having this file allows us to control
the loading of serivce files conditionally.</p><p>The service files will not be loaded by Laravel if it weren&rsquo;t registered. We used the simple method of adding the provider
to the app&rsquo;s <code>providers</code> array which means that the service files will be registered in every interaction with our application.
This may not always be the intented behaviour, where we would want to register services conditionally.</p><p>For example, if we wish to load only Kitchen service if our domain matches <code>kitchen.example.com</code> we would instead register
the provider in <code>app/Providers/AppServiceProvider::regsiter</code> as such:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>regsiter</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>switch</span> <span class=p>(</span><span class=nx>Route</span><span class=o>::</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;subdomain&#39;</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>case</span> <span class=s1>&#39;kitchen&#39;</span><span class=o>:</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>register</span><span class=p>(</span><span class=nx>KitchenServiceProvider</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=s1>&#39;forum&#39;</span><span class=o>:</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>register</span><span class=p>(</span><span class=nx>ForumServiceProvider</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Given that we define our routes with a subdomain group:</p><p><code>app/Services/Kitchen/routes/web.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nx>Route</span><span class=o>::</span><span class=na>group</span><span class=p>([</span><span class=s1>&#39;domain&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;{subdomain}.cookery.local&#39;</span><span class=p>],</span> <span class=k>function</span><span class=p>()</span> <span class=p>{</span>

    <span class=c1>// define Kitchen routes here
</span><span class=c1></span>
<span class=p>});</span>
</code></pre></div><h2 ref=authentication>Authentication</h2><a class=anchor id=authentication></a><p>We will try to avoid re-inventing the wheel as much as possible by using <a href=https://github.com/laravel/breeze><code>laravel/breeze</code></a>
to scaffold configuration and Auth routes, views and controllers styled with TailwindCSS.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>composer require laravel/breeze --dev

php artisan breeze:install

npm install <span class=o>&amp;&amp;</span> npm run dev
</code></pre></div><p>Now to watch assets and build on change we may run <code>npm run watch</code>.</p><p>The resulting files are under <code>resources/views/auth</code> and the <code>welcome</code> page has been updated to look as follows:</p><p><img src=/media/images/getting-started/welcome.png alt=Welcome></p><p>To create an account click on Register at the top right and enter your account details to be logged in to the dashboard:</p><p><img src=/media/images/getting-started/register.png alt=Register></p><div class="notices info"><p>Authentication is central to our application, the same user will be accessing both the forum and the kitchen.
We&rsquo;re keeping auth and <code>User</code> at root for the brevity of this example but ideally we&rsquo;d move the <code>User</code> model to our <code>Data/Models</code> directory
and adapt Auth to read it from there in <code>config/auth.php</code>, though this is not necessary for now.</p></div><h2 ref=recipe-submission>Recipe Submission</h2><a class=anchor id=recipe-submission></a><p>The first feature we will work on is to receive a recipe&rsquo;s details and add it to our records. Starting with the form:</p><h3 ref=view>View</h3><a class=anchor id=view></a><p><code>app/Services/Kitchen/routes/web.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nx>Route</span><span class=o>::</span><span class=na>group</span><span class=p>([</span><span class=s1>&#39;prefix&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;kitchen&#39;</span><span class=p>],</span> <span class=k>function</span><span class=p>()</span> <span class=p>{</span>

    <span class=nx>Route</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;/recipes/new&#39;</span><span class=p>,</span> <span class=k>function</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>view</span><span class=p>(</span><span class=s1>&#39;kitchen::new&#39;</span><span class=p>);</span>
    <span class=p>});</span>

<span class=p>});</span>

</code></pre></div><p>Next, we need to create the form at <code>app/Services/Kitchen/resources/views/new.blade.php</code> with the styles:</p><p><code>resources/css/app.css</code></p><div class=highlight><pre class=chroma><code class=language-scss data-lang=scss><span class=k>@import</span> <span class=s1>&#39;tailwindcss/base&#39;</span><span class=p>;</span>
<span class=k>@import</span> <span class=s1>&#39;tailwindcss/components&#39;</span><span class=p>;</span>
<span class=k>@import</span> <span class=s1>&#39;tailwindcss/utilities&#39;</span><span class=p>;</span>

<span class=k>@layer</span> <span class=nt>components</span> <span class=p>{</span>
    <span class=nc>.form-container</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>flex</span> <span class=nt>items-center</span> <span class=nt>justify-center</span> <span class=nt>h-screen</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>w-full</span> <span class=nt>max-w-sm</span> <span class=nt>bg-white</span> <span class=nt>shadow-md</span> <span class=nt>rounded</span> <span class=nt>px-8</span> <span class=nt>pt-6</span> <span class=nt>pb-8</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-label</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>block</span> <span class=nt>text-gray-500</span> <span class=nt>font-bold</span> <span class=nt>mb-1</span> <span class=nt>pr-4</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-error-status-message</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>bg-red-100</span> <span class=nt>border</span> <span class=nt>border-red-400</span> <span class=nt>text-red-700</span> <span class=nt>px-4</span> <span class=nt>py-3</span> <span class=nt>mt-2</span> <span class=nt>mb-2</span> <span class=nt>rounded</span> <span class=nt>relative</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-input-row</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>flex</span> <span class=nt>items-center</span> <span class=nt>mb-6</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-input-error-label</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>text-red-500</span> <span class=nt>text-xs</span> <span class=nt>italic</span> <span class=nt>mt-2</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-input</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>appearance-none</span> <span class=nt>border-2</span> <span class=nt>rounded</span> <span class=nt>w-full</span> <span class=nt>py-2</span> <span class=nt>px-4</span> <span class=nt>text-gray-700</span> <span class=nt>leading-tight</span> <span class=nt>border-gray-200</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.form-input</span><span class=nd>:focus</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>bg-white</span> <span class=nt>border-teal-500</span> <span class=nt>outline-none</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.btn</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>shadow</span> <span class=nt>bg-teal-500</span> <span class=nt>text-white</span> <span class=nt>font-bold</span> <span class=nt>py-2</span> <span class=nt>px-4</span> <span class=nt>rounded</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nc>.btn</span><span class=nd>:hover</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>bg-teal-400</span>
    <span class=p>}</span>

    <span class=nc>.btn</span><span class=nd>:focus</span> <span class=p>{</span>
        <span class=k>@apply</span> <span class=nt>shadow-outline</span> <span class=nt>outline-none</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></div><div class="notices info"><p>It is recommended to scope styles per service as well, but it would&rsquo;ve required a couple more steps that we&rsquo;d rather
skip for being out of the scope of this guide. i.e. loading a custom CSS file from <code>app/Services/Kitchen/resources/css/kitchen.css</code></p></div><p><code>app/Services/Kitchen/resources/views/new.blade.php</code></p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>x-app-layout</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>x-slot</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;header&#34;</span><span class=p>&gt;</span>
        Add Recipe
    <span class=p>&lt;/</span><span class=nt>x-slot</span><span class=p>&gt;</span>

    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-container&#34;</span><span class=p>&gt;</span>
        <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/submit&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form&#34;</span><span class=p>&gt;</span>
            @csrf
            @if ($errors-&gt;any())
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-error-status-message&#34;</span> <span class=na>role</span><span class=o>=</span><span class=s>&#34;alert&#34;</span><span class=p>&gt;</span>
                    Please fix the following errors
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            @endif
            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input-row&#34;</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-1/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-label&#34;</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;title&#34;</span><span class=p>&gt;</span>
                        Title
                    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-2/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;title&#34;</span>
                           <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span>
                           <span class=na>name</span><span class=o>=</span><span class=s>&#34;title&#34;</span>
                           <span class=na>value</span><span class=o>=</span><span class=s>&#34;{{ old(&#39;title&#39;) }}&#34;</span>
                           <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input&#34;</span><span class=p>&gt;</span>
                    @error(&#39;title&#39;)
                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input-error-label&#34;</span><span class=p>&gt;</span>{{ $message }}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
                    @enderror
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>

            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input-row&#34;</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-1/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;ingredients&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-label&#34;</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;desription&#34;</span><span class=p>&gt;</span>
                        Ingredients
                    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-2/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;text-gray-500 text-xs&#34;</span><span class=p>&gt;</span>each ingredient on a new line.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;text-gray-500 text-xs&#34;</span><span class=p>&gt;</span>Ingredient, mass /g, $ /g<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;ingredients&#34;</span>
                              <span class=na>name</span><span class=o>=</span><span class=s>&#34;ingredients&#34;</span>
                              <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input h-48&#34;</span>
                              <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Avocado, 0.5, 0.07
</span><span class=s>                              Lettuce, 0.3, 0.04&#34;</span><span class=p>&gt;</span>{{ old(&#39;ingredients&#39;) }}<span class=p>&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span>
                    @error(&#39;ingredients&#39;)
                    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input-error-label&#34;</span><span class=p>&gt;</span>{{ $message }}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
                    @enderror
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>

            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input-row&#34;</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-1/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;instructions&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-label&#34;</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;desription&#34;</span><span class=p>&gt;</span>
                        Instructions
                    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-2/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;instructions&#34;</span>
                              <span class=na>name</span><span class=o>=</span><span class=s>&#34;instructions&#34;</span>
                              <span class=na>class</span><span class=o>=</span><span class=s>&#34;form-input h-24&#34;</span>
                              <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;How to do it?&#34;</span><span class=p>&gt;</span>{{ old(&#39;instructions&#39;) }}<span class=p>&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>

            <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:flex md:items-center&#34;</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-1/3&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
                <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;md:w-2/3&#34;</span><span class=p>&gt;</span>
                    <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;btn&#34;</span><span class=p>&gt;</span>
                        Add
                    <span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
                <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>x-app-layout</span><span class=p>&gt;</span>
</code></pre></div><p>It&rsquo;s a simple form:</p><div class=card><div class=card-body><p class=card-text><p><img src=/media/images/getting-started/add-recipe.png alt="Add Recipe Form"></p></p></div></div><h3 ref=controller>Controller</h3><a class=anchor id=controller></a><p>Generate <code>RecipeController</code> in Kitchen service to handle recipe requests and serve corresponding features:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:controller recipe kitchen
</code></pre></div><pre><code>Controller class created successfully.

Find it at app/Services/Kitchen/Http/Controllers/RecipeController.php
</code></pre><div class="notices info"><p>Notice the automatic addition of <code>Controller</code> suffix, used as a naming convention to match other suffixes in the Lucid stack such as <code>Feature</code>, <code>Job</code> and <code>Operation</code>.</p></div><p>We will need a method to handle the form&rsquo;s submission request, let&rsquo;s call it <code>add</code>:</p><p><code>app/Services/Kitchen/Http/Controllers/RecipeController.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Kitchen\Http\Controllers</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Controller</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>RecipeController</span> <span class=k>extends</span> <span class=nx>Controller</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>add</span><span class=p>()</span>
    <span class=p>{</span>

    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 ref=feature>Feature</h3><a class=anchor id=feature></a><p>The <code>add</code> method will then serve the feature that will run the jobs and operations required to add recipes.
Generate a feature called <code>AddRecipeFeature</code> in Kitchen service:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:feature AddRecipe kitchen
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Feature class AddRecipeFeature created successfully.

Find it at app/Services/Kitchen/Features/AddRecipeFeature.php
</code></pre></div><p><code>add()</code> will now serve <code>AddRecipeFeature</code></p><p><code>app/Services/Kitchen/Http/Controllers/RecipeController.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>App\Services\Kitchen\Features\AddRecipeFeature</span><span class=p>;</span>

<span class=o>...</span>

<span class=k>public</span> <span class=k>function</span> <span class=nf>add</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>serve</span><span class=p>(</span><span class=nx>AddRecipeFeature</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Beginning with the step of generating a feature will cognitively set our context to what we will be working on, helping us concentrate
on the task at hand.</p><p>Let&rsquo;s expose our feature with a route:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>App\Services\Kitchen\Http\Controllers\RecipeController</span><span class=p>;</span>

<span class=nx>Route</span><span class=o>::</span><span class=na>group</span><span class=p>([</span><span class=s1>&#39;prefix&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;kitchen&#39;</span><span class=p>],</span> <span class=k>function</span><span class=p>()</span> <span class=p>{</span>

    <span class=nx>Route</span><span class=o>::</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/recipes&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>RecipeController</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=s1>&#39;add&#39;</span><span class=p>]);</span>

<span class=p>});</span>

</code></pre></div><h3 ref=database>Database</h3><a class=anchor id=database></a><p>Before we can start accepting data we need to prepare our database with a migration to create the recipes table:</p><p>We would like our kitchen tables to be managed by the Kitchen service, so we will place the migrations
in <code>app/Services/Kitchen/database/migraitons</code> instead of the default <code>database/migrations</code>.
This is an optional step and may not fit all cases, but the option is here when needed using the <code>lucid make:migration</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:migration create_recipes_table kitchen
</code></pre></div><pre><code>Created Migration: 2020_11_18_211503_create_recipes_table


Find it at app/Services/Kitchen/database/migrations
</code></pre><p>Now we update the table&rsquo;s schema at <code>app/Services/Kitchen/database/migrations/{datetime}_create_recipes_table.php</code>
to include recipe fields and a reference to the user:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nx>Schema</span><span class=o>::</span><span class=na>create</span><span class=p>(</span><span class=s1>&#39;recipes&#39;</span><span class=p>,</span> <span class=k>function</span> <span class=p>(</span><span class=nx>Blueprint</span> <span class=nv>$table</span><span class=p>)</span> <span class=p>{</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>();</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>string</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>);</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>text</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>);</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>text</span><span class=p>(</span><span class=s1>&#39;instructions&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>nullable</span><span class=p>();</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>decimal</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>3</span><span class=p>);</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>unsignedBigInteger</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>);</span>
    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>timestamps</span><span class=p>();</span>

    <span class=nv>$table</span><span class=o>-&gt;</span><span class=na>foreign</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
          <span class=o>-&gt;</span><span class=na>references</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span>
          <span class=o>-&gt;</span><span class=na>on</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>The migration will automatically be registered so the next time we run <code>php artisan migrate</code> <code>recipes</code> table will be created:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>php artisan migrate
</code></pre></div><pre><code>Migrating: 2020_11_18_211503_create_recipes_table
Migrated:  2020_11_18_211503_create_recipes_table (5.43ms)
</code></pre><h3 ref=model>Model</h3><a class=anchor id=model></a><div class=card><div class=card-body><p class=card-text><p><strong>The Data Directory <code>app/Data</code></strong></p><p>For a scalable set of interconnected data elements, with Lucid we place them in <code>app/Data</code>,
because most likely over time writing the application there could develop a need for more than Models in data,
such as Repositories, Value Objects, Collections and more&mldr; which all fit in a central directory to consolidate them.</p></p></div></div><p>Create the <code>Recipe</code> model class at <code>app/Data/Models/Recipe.php</code> with the fields in <code>$fillable</code> for mass assignment:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Data\Models</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Illuminate\Database\Eloquent\Model</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Recipe</span> <span class=k>extends</span> <span class=nx>Model</span>
<span class=p>{</span>
    <span class=k>protected</span> <span class=nv>$fillable</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;ingredients&#39;</span><span class=p>,</span> <span class=s1>&#39;instructions&#39;</span><span class=p>,</span> <span class=s1>&#39;price&#39;</span><span class=p>,</span> <span class=s1>&#39;user_id&#39;</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></div><h3 ref=request-validation>Request Validation</h3><a class=anchor id=request-validation></a><p>The first step of receiving input is to validate it. We will be using <a href=https://laravel.com/docs/validation#form-request-validation>Form Request validation</a>
where each Request belongs in a Domain representing the entity that&rsquo;s being managed, in this case it&rsquo;s <code>Recipe</code> containing an <code>AddRecipe</code> Request class.</p><p>This will be the beginning of working with Domains in Lucid. They&rsquo;re used to group Jobs and custom classes which logic is
associated with certain topic according to domain-driven design.</p><p>Starting with validation, Lucid places Request classes within their corresponding domains. Let&rsquo;s generate an <code>AddRecipe</code> request:</p><div class="notices light"><p><i class="fas fa-asterisk"></i> About the naming of the request class, it also would be an option to name it <code>CreateRecipe</code>
instead of <code>AddRecipe</code> to fulfill the CRUD convention, but <code>AddRecipe</code> was easier to read and pronounce in this particular case.</p></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:request AddRecipe recipe
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Request class created successfully.

Find it at app/Domains/Recipe/Requests/AddRecipe.php
</code></pre></div><p>In <code>AddRecipe</code> we&rsquo;ll need to update the methods <code>authorize()</code> and <code>rules()</code> to validate the request and its input.
Validation rules are the essentials:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Recipe\Requests</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Auth</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Foundation\Http\FormRequest</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>AddRecipe</span> <span class=k>extends</span> <span class=nx>FormRequest</span>
<span class=p>{</span>
    <span class=sd>/**
</span><span class=sd>     * Determine if the user is authorized to make this request.
</span><span class=sd>     *
</span><span class=sd>     * @return bool
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>authorize</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>check</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Get the validation rules that apply to the request.
</span><span class=sd>     *
</span><span class=sd>     * @return array
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>rules</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=p>[</span>
            <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;required&#39;</span><span class=p>,</span> <span class=s1>&#39;max:255&#39;</span><span class=p>],</span>
            <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;required&#39;</span><span class=p>,</span> <span class=s1>&#39;max:255&#39;</span><span class=p>],</span>
            <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;max:255&#39;</span><span class=p>],</span>
        <span class=p>];</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>With our request ready, now we need <code>AddRecipeFeature</code> to use that request class when served. We can do that by simply injecting
the request class in the feature&rsquo;s <code>handle()</code> method and every time the feature is served this validation will be applied.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Kitchen\Features</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Feature</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Recipe\Requests\AddRecipe</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>AddRecipeFeature</span> <span class=k>extends</span> <span class=nx>Feature</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>AddRecipe</span> <span class=nv>$request</span><span class=p>)</span>
    <span class=p>{</span>

    <span class=p>}</span>
<span class=p>}</span>

</code></pre></div><p>Now if we visit <code>/submit</code> and click <code>Add</code> wihtout passing any input it will generate errors and print their messages from validation failures.</p><p><img src=/media/images/getting-started/recipes-validation-errors.png alt="Validation errors UI"></p><h3 ref=calculate-recipe-price>Calculate Recipe Price</h3><a class=anchor id=calculate-recipe-price></a><p>To calculate the recipe price we need to do the following:</p><ol><li>Parse the ingredients into an associative array with: <code>name</code>, <code>quantity</code> and <code>price</code></li><li>Get each ingredient&rsquo;s usage price: <code>quantity x price</code></li><li>Sum all ingredient usage prices to get recipe price <code>∑ ingredient price</code></li></ol><h4 ref=value-objects>Value Objects</h4><a class=anchor id=value-objects></a><p>Looking at this requirement it seems that each step fits within a job, but thinking a little longer spawns the idea of Value Objects into thought.
Especially that there will be data exchange between several jobs.</p><p>The prominent idea would be to have an <code>Ingredient</code> object that&rsquo;s passed around instead of a primitive data type - associative array.
It will make it easier for someone reading the code to tell the structure (fields) by referring to the class rather than having to guess
and run after associative array key assignment instructions to figure out the final structure.</p><p>In other words, let&rsquo;s represent our <code>Ingredient</code> as a Value Object! Unlike models, value objects are only to be used at run
time and never stored.</p><div class="notices info"><p><i class="fas fa-exclamation"></i> This concept is NOT related to the Lucid architecture although
endorsed for scale. For more on value objects, Martin Fowler put it best in <a href=https://martinfowler.com/bliki/ValueObject.html>ValueObject</a>
in the domain-driven design section.</p></div><p>This brings up another advantage for the <code>app/Data</code> directory which will hold our value objects in <code>app/Data/Values</code> next to <code>app/Data/Models</code>.</p><p>Create <code>Ingredient</code> value object at <code>app/Data/Values/Ingredient.php</code> and we make it optional to have <code>quantity</code> and <code>price</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Data\Values</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Ingredient</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=nx>string</span> <span class=nv>$name</span><span class=p>;</span>
    <span class=k>public</span> <span class=nx>float</span> <span class=nv>$quantity</span><span class=p>;</span>
    <span class=k>public</span> <span class=nx>float</span> <span class=nv>$price</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>,</span> <span class=nx>float</span> <span class=nv>$quantity</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>float</span> <span class=nv>$price</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>quantity</span> <span class=o>=</span> <span class=nv>$quantity</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span> <span class=o>=</span> <span class=nv>$price</span><span class=p>;</span>
    <span class=p>}</span>

<span class=p>}</span>

</code></pre></div><h4 ref=step-1-parse-ingredients>Step 1: Parse Ingredients</h4><a class=anchor id=step-1-parse-ingredients></a><p>Now we create a job that receives the <code>Recipe</code> model and parses <code>ingredient</code> field into <code>Ingredent</code> instances, calling it
<code>ParseIngredientsJob</code>.</p><p>Since we will be dealing with several instances, <code>Collection</code> classes are a powerful superset to array and it woule be perfect
to extend and make it easier for the receiver of the results to use and extract value from.</p><p>Let&rsquo;s create a specific collection for ingredients to pass around in <code>app/Data/Collections/IngredientsCollection.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Data\Collections</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Illuminate\Support\Collection</span><span class=p>;</span>

<span class=sd>/**
</span><span class=sd> * A collection of Ingredient instances.
</span><span class=sd> */</span>
<span class=k>class</span> <span class=nc>IngredientsCollection</span> <span class=k>extends</span> <span class=nx>Collection</span>
<span class=p>{</span>

<span class=p>}</span>
</code></pre></div><p>Now we can type-hint for it and visually represent what we&rsquo;re expecting in this collection.</p><p>Next is <code>ParseIngredientsJob</code> that will have the logic for this transformation from a string of ingredients
to <code>IngredientsCollection</code> containing <code>Ingredient</code> value object instances.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job ParseIngredientsJob recipe
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Job class ParseIngredientsJob created successfully.

Find it at app/Domains/Recipe/Jobs/ParseIngredientsJob.php
</code></pre></div><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Recipe\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Recipe</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Values\Ingredient</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Collections\IngredientsCollection</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>ParseIngredientsJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * Create a new job instance.
</span><span class=sd>     *
</span><span class=sd>     * @param string $ingredients
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span> <span class=o>=</span> <span class=nv>$ingredients</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Execute the job.
</span><span class=sd>     *
</span><span class=sd>     * @return IngredientsCollection
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>IngredientsCollection</span>
    <span class=p>{</span>
        <span class=nv>$ingredients</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>IngredientsCollection</span><span class=p>();</span>

        <span class=k>foreach</span> <span class=p>(</span><span class=nx>array_filter</span><span class=p>(</span><span class=nx>explode</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span><span class=p>))</span> <span class=k>as</span> <span class=nv>$line</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$ingredient</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ingredient</span><span class=p>(</span><span class=o>...</span><span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=nv>$line</span><span class=p>));</span>
            <span class=nv>$ingredients</span><span class=o>-&gt;</span><span class=na>push</span><span class=p>(</span><span class=nv>$ingredient</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=nv>$ingredients</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>We have oursleves a job that can be called anywhere we receive a string of ingredients and would like to parse it.</p><p>A bit about the code above:</p><ul><li><code>array_filter(explode("\r\n", $this->ingredients))</code> turns new lines into array elements and removes empty ones</li><li><code>new Ingredient(...explode(',', $line))</code> creates a new <code>Ingredients</code> instance by turning comma separated string into parameters</li></ul><p>The returned result from that job would look like this:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nx>App\Data\Collections\IngredientsCollection</span> <span class=p>{</span>
  <span class=nx>items</span><span class=o>:</span> <span class=p>[</span>
    <span class=mi>0</span> <span class=o>=&gt;</span> <span class=nx>App\Data\Values\Ingredient</span> <span class=p>{</span>
      <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Avocado&#34;</span>
      <span class=nx>quantity</span><span class=o>:</span> <span class=mf>0.5</span>
      <span class=nx>price</span><span class=o>:</span> <span class=mf>0.07</span>
      <span class=nx>total</span><span class=o>:</span> <span class=mf>0.035</span>
    <span class=p>}</span>
    <span class=mi>1</span> <span class=o>=&gt;</span> <span class=nx>App\Data\Values\Ingredient</span> <span class=p>{</span>
      <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Lettuce&#34;</span>
      <span class=nx>quantity</span><span class=o>:</span> <span class=mf>0.3</span>
      <span class=nx>price</span><span class=o>:</span> <span class=mf>0.04</span>
      <span class=nx>total</span><span class=o>:</span> <span class=mf>0.012</span>
    <span class=p>}</span>
  <span class=p>]</span>
</code></pre></div><h4 ref=step-2-calculate-ingredients-total-price>Step 2: Calculate Ingredient&rsquo;s Total Price</h4><a class=anchor id=step-2-calculate-ingredients-total-price></a><p>To calculate an ingredient&rsquo;s own total price we simply do <code>$quantity * $price</code> but the question is where should this code be?</p><p>The thinking process to figure that out starts with the question &ldquo;where would the next person look for this?&rdquo; and the best answer to it wins.
In this case, to know the price of an ingredient, it is obvious that the first place to look is the <code>Ingredient</code> value object.
Becuase if we were to put it somewhere else outside the class, the next time we visit <code>Ingredient</code> we&rsquo;d see that it recieves the total
price as an argument in its constructor but then we&rsquo;d have to search for the place where this is being set.
Besides having an hidden dependency between classes.</p><p>Let&rsquo;s update <code>Ingredient</code> class to calculate its own total:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Data\Values</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Ingredient</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=nx>string</span> <span class=nv>$name</span><span class=p>;</span>
    <span class=k>public</span> <span class=nx>float</span> <span class=nv>$quantity</span><span class=p>;</span>
    <span class=k>public</span> <span class=nx>float</span> <span class=nv>$price</span><span class=p>;</span>
    <span class=k>public</span> <span class=nx>float</span> <span class=nv>$total</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$name</span><span class=p>,</span> <span class=nx>float</span> <span class=nv>$quantity</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>float</span> <span class=nv>$price</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>name</span> <span class=o>=</span> <span class=nv>$name</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>quantity</span> <span class=o>=</span> <span class=nv>$quantity</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span> <span class=o>=</span> <span class=nv>$price</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>total</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>calculateTotal</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>calculateTotal</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>quantity</span> <span class=o>*</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h4 ref=step-3-calculate-recipe-total-price>Step 3: Calculate Recipe Total Price</h4><a class=anchor id=step-3-calculate-recipe-total-price></a><p>Let&rsquo;s create a job to calculate the total price from <code>IngredientsCollection</code> calling it <code>CalculateIngredientsTotalJob</code> and returns
a single <code>float</code> value.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job CalculateIngredientsTotalJob recipe
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Job class CalculateIngredientsTotalJob created successfully.

Find it at app/Domains/Recipe/Jobs/CalculateIngredientsTotalJob.php
</code></pre></div><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Recipe\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Collections\IngredientsCollection</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>CalculateIngredientsTotalJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>IngredientsCollection</span> <span class=nv>$ingredients</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * Create a new job instance.
</span><span class=sd>     *
</span><span class=sd>     * @param IngredientsCollection $ingredients
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>IngredientsCollection</span> <span class=nv>$ingredients</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span> <span class=o>=</span> <span class=nv>$ingredients</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Execute the job.
</span><span class=sd>     *
</span><span class=sd>     * @return float
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>float</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span><span class=o>-&gt;</span><span class=na>sum</span><span class=p>(</span><span class=s1>&#39;total&#39;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h4 ref=run-the-jobs>Run The Jobs</h4><a class=anchor id=run-the-jobs></a><p>Now in <code>AddRecipeFeature</code> we run the jobs:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>AddRecipe</span> <span class=nv>$request</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>ParseIngredientsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
    <span class=p>]);</span>

    <span class=nv>$price</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>CalculateIngredientsTotalJob</span><span class=p>(</span><span class=nv>$ingredients</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div><h4 ref=final-step-group-jobs-in-operations>Final Step: Group Jobs In Operations</h4><a class=anchor id=final-step-group-jobs-in-operations></a><p>It is indispensable for <code>ParseIngredientsJob</code> and <code>CalculateIngredientsTotalJob</code> to run together every time we need to calculate a recipe&rsquo;s price.
This case spawns <a href=https://docs.lucidarch.dev/operations/>Operations</a> into thought, to group these steps in one operation
that we can simply run with Lucid <code>$this->run(new CalculateRecipePriceOperation($ingredient))</code> which runs jobs performing both steps above.
Moreover, we would still be able to run any of the jobs separatly in different conditions if needed.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:operation CalculateRecipePrice kitchen
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Operation class CalculateRecipePriceOperation created successfully.

Find it at app/Services/Kitchen/Operations/CalculateRecipePriceOperation.php
</code></pre></div><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Kitchen\Operations</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Operation</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Collections\IngredientsCollection</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Recipe\Jobs\ParseIngredientsJob</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Recipe\Jobs\CalculateIngredientsTotalJob</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>CalculateRecipePriceOperation</span> <span class=k>extends</span> <span class=nx>Operation</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span> <span class=o>=</span> <span class=nv>$ingredients</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>float</span>
    <span class=p>{</span>
        <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>ParseIngredientsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span><span class=p>,</span>
        <span class=p>]);</span>

        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>CalculateIngredientsTotalJob</span><span class=p>(</span><span class=nv>$ingredients</span><span class=p>));</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Then in the feature we&rsquo;d replace the two jobs with just one call:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>AddRecipe</span> <span class=nv>$request</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$price</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>CalculateRecipePriceOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
    <span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><h3 ref=save-recipes>Save Recipes</h3><a class=anchor id=save-recipes></a><p>To save the recipe we&rsquo;ll create a job that saves recipes and run it in our feature, which will be added to our <code>Recipe</code> domain at
<code>app/Domains/Recipe/Jobs/SaveRecipeJob</code> along with its test <code>app/Domains/Recipes/Tests/Jobs/SaveRecipeJobTest</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job SaveRecipe recipe
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Job class SaveRecipeJob created successfully.

Find it at app/Domains/Recipe/Jobs/SaveRecipeJob.php
</code></pre></div><div class="notices info"><p><i class="fas fa-asterisk"></i> Notice the naming that we&rsquo;ve used with this job &ldquo;<code>SaveRecipeJob</code>&rdquo; in contrast with &ldquo;<code>AddRecipe</code>&rdquo;.
It is intended for reuse whenever needed by extending its functionality futher, for example <code>UpdateRecipe</code> feature may be able to use the same job.</p></div><p><code>SaveRecipeJob</code> should define the parameters that are required in its constructor, a.k.a the job&rsquo;s <em>signature</em>, rather than accessing
the data from the request so that we can call this job from other places in our application (e.g. from a command or a custom class)
and not be restricted by the protocol, in this case HTTP request.</p><p>We use this technique to increase the degree of job isolation and secure the single responsibility principle.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Recipe\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Models\User</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Models\Recipe</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>SaveRecipeJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$title</span><span class=p>;</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>;</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$instructions</span><span class=p>;</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$price</span><span class=p>;</span>
    <span class=k>private</span> <span class=nx>User</span> <span class=nv>$user</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * Create a new job instance.
</span><span class=sd>     *
</span><span class=sd>     * @param $title
</span><span class=sd>     * @param $ingredients
</span><span class=sd>     * @param $instructions
</span><span class=sd>     * @param $price
</span><span class=sd>     * @param User $user
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$title</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>,</span> <span class=nv>$instructions</span><span class=p>,</span> <span class=nv>$price</span><span class=p>,</span> <span class=nx>User</span> <span class=nv>$user</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>title</span> <span class=o>=</span> <span class=nv>$title</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span> <span class=o>=</span> <span class=nv>$ingredients</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>instructions</span> <span class=o>=</span> <span class=nv>$instructions</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span> <span class=o>=</span> <span class=nv>$price</span><span class=p>;</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>user</span> <span class=o>=</span> <span class=nv>$user</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Execute the job.
</span><span class=sd>     *
</span><span class=sd>     * @return Recipe
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>Recipe</span>
    <span class=p>{</span>
        <span class=nv>$attributes</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>title</span><span class=p>,</span>
            <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>ingredients</span><span class=p>,</span>
            <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>instructions</span><span class=p>,</span>
            <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>,</span>
            <span class=s1>&#39;user_id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>user</span><span class=o>-&gt;</span><span class=na>getKey</span><span class=p>(),</span>
        <span class=p>];</span>

        <span class=k>return</span> <span class=nx>tap</span><span class=p>(</span><span class=k>new</span> <span class=nx>Recipe</span><span class=p>(</span><span class=nv>$attributes</span><span class=p>))</span><span class=o>-&gt;</span><span class=na>save</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></div><p>The job&rsquo;s signature is its constructor: <code>__construct($title, $ingredients, $instructions, $price)</code> telling us what&rsquo;s required to run this job.
This gets easier to read and use with PHP 7+ where we could type-hit these parameters:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span>
    <span class=nx>string</span> <span class=nv>$title</span><span class=p>,</span>
    <span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>,</span>
    <span class=nx>string</span> <span class=nv>$instructions</span><span class=p>,</span>
    <span class=nx>int</span> <span class=nv>$price</span><span class=p>)</span>
</code></pre></div><p>And even better with PHP 8 we could use constructor property promotion and further reduce boilerplate:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$title</span><span class=p>,</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$ingredients</span><span class=p>,</span>
    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$instructions</span><span class=p>,</span>
    <span class=k>private</span> <span class=nx>int</span> <span class=nv>$price</span>
<span class=p>)</span> <span class=p>{}</span>
</code></pre></div><div class="notices info"><p><i class="fas fa-lightbulb"></i> <strong>Note On Storage Approach</strong></p><p>We are taking a rather untraditional approach in this example. Easy on storage by saving ingredients as plain text rather than splitting them up into
their own model and building many-to-many relationships between recipes and ingredients, which may have been a better approach from a storage perspective.
However, for the sake of demonstrating a more complex case where we split them up and represent them in value objects,
because the relational approach is a familiar one and this example covers a wider range for variety reasons.</p></div><p>Then we&rsquo;ll run this job from the feature to save recipes when served:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>AddRecipe</span> <span class=nv>$request</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$price</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>CalculateRecipePriceOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
    <span class=p>]);</span>

    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SaveRecipeJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
        <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;instructions&#39;</span><span class=p>),</span>
        <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$price</span><span class=p>,</span>
        <span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>user</span><span class=p>(),</span>
    <span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><p>Calling <code>$this->run($unit, $params)</code> in a feature triggers the underlying dispatcher to run <code>SaveRecipeJob</code> instantly and syncronously by calling its <code>handle</code> method
after initializing it with the provided <code>$params</code> which are passed as an associative array where the keys must match the job&rsquo;s
constructor parameters in naming, but not the order. So this would still work the same:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SaveRecipeJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;instructions&#39;</span><span class=p>),</span>
    <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
    <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$price</span><span class=p>,</span>
    <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
<span class=p>]);</span>
</code></pre></div><div class="notices info"><p><i class="fas fa-info-circle"></i> You may call jobs (and other units) from any class by
supplying <code>Lucid\Bus\UnitDispatcher</code> trait in the class which will equip the <code>run($unit, $params)</code> function to run jobs and operations.
With this, the class in Lucid terms is now called a <a href=https://docs.lucidarch.dev/jobs/#custom-dispatcher>custom dispatcher</a>.</p></div><p>The last step is to redirect a successful request back to the form. To do that we&rsquo;ll create a <code>RedirectBackJob</code>
which will simply call <code>back()</code>. Even though it might seem like an overhead, but remember that we&rsquo;re setting up for scale,
and as we scale, the less free-form code we have the better; instead of having plenty of <code>back()</code> and <code>back()->withInput()</code>
and other calls, we centralize them in a job so that in case we ever wanted to modify that functionality or add to it,
the change will only need to happen in a one place.</p><p><code>RedirectBackJob</code> will reside in a new <code>Http</code> domain, a place for all our HTTP-related functionality that isn&rsquo;t specific to a
business entity of our application, fits the abstract type of domains instead of the entity type.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job RedirectBackJob http
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Job class RedirectBackJob created successfully.

Find it at app/Domains/Http/Jobs/RedirectBackJob.php
</code></pre></div><p>Our job will provide the option <code>withInput</code> to determine whether input should be included in the redirection.
This is a simple example of how such a simple job may later provide functionality that can be shared across the application.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Http\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>RedirectBackJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=sd>/**
</span><span class=sd>     * @var bool
</span><span class=sd>     */</span>
    <span class=k>private</span> <span class=nv>$withInput</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * Create a new job instance.
</span><span class=sd>     *
</span><span class=sd>     * @param bool $withInput
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$withInput</span> <span class=o>=</span> <span class=k>false</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>withInput</span> <span class=o>=</span> <span class=nv>$withInput</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * Execute the job.
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$back</span> <span class=o>=</span> <span class=nx>back</span><span class=p>();</span>

        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>withInput</span><span class=p>)</span> <span class=p>{</span>
            <span class=nv>$back</span><span class=o>-&gt;</span><span class=na>withInput</span><span class=p>();</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=nv>$back</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Finally, conclude the feature by responding:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>AddRecipe</span> <span class=nv>$request</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$price</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>CalculateRecipePriceOperation</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
    <span class=p>]);</span>

    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SaveRecipeJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;ingredients&#39;</span><span class=p>),</span>
        <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;instructions&#39;</span><span class=p>),</span>
        <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$price</span><span class=p>,</span>
        <span class=s1>&#39;user&#39;</span> <span class=o>=&gt;</span> <span class=nx>Auth</span><span class=o>::</span><span class=na>user</span><span class=p>(),</span>
    <span class=p>]);</span>

    <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RedirectBackJob</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h2 ref=testing>Testing</h2><a class=anchor id=testing></a><p>If you visit <code>/kitchen/recipes/new</code> and fill the form it should now add the recipes, but to be certain about the functionality we just built
it is necessary that we write some tests to ensure it continues to.</p><h3 ref=configure-phpunit>Configure PHPUnit</h3><a class=anchor id=configure-phpunit></a><p>First we need to configure the database to run in a memory SQLite database instance, in <code>phpunit.xml</code>
uncomment the following lines:</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;server</span> <span class=na>name=</span><span class=s>&#34;DB_CONNECTION&#34;</span> <span class=na>value=</span><span class=s>&#34;sqlite&#34;</span><span class=nt>/&gt;</span>
<span class=nt>&lt;server</span> <span class=na>name=</span><span class=s>&#34;DB_DATABASE&#34;</span> <span class=na>value=</span><span class=s>&#34;:memory:&#34;</span><span class=nt>/&gt;</span>
</code></pre></div><p>And for domains and services tests to be automatically detected by PHPunit,
we&rsquo;ll need to add the following snippet to <code>phpunit.xml</code> within the <code>&lt;testsuites></code> tag:</p><div class=highlight><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;testsuite</span> <span class=na>name=</span><span class=s>&#34;Domains&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;directory</span> <span class=na>suffix=</span><span class=s>&#34;Test.php&#34;</span><span class=nt>&gt;</span>./app/Domains<span class=nt>&lt;/directory&gt;</span>
<span class=nt>&lt;/testsuite&gt;</span>
<span class=nt>&lt;testsuite</span> <span class=na>name=</span><span class=s>&#34;Services&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;directory</span> <span class=na>suffix=</span><span class=s>&#34;Test.php&#34;</span><span class=nt>&gt;</span>./app/Services/*/Tests<span class=nt>&lt;/directory&gt;</span>
<span class=nt>&lt;/testsuite&gt;</span>
</code></pre></div><div class="notices secondary"><p>This also allows us to run this suite in isolation with <code>phpunit --testsuite Domains</code></p></div><h3 ref=unit-tests>Unit Tests</h3><a class=anchor id=unit-tests></a><p>Jobs in Lucid are units, and their tests are that of a unit test where we verify that all the variations of the data it might
receive wouldn&rsquo;t misbehave unexpectedly.</p><div class="notices danger"><p><i class="fas fa-exclamation-triangle"></i> Runnig tests prior to configuring <code>phpunit.xml</code> as mentioned above will wipe
out the data that is currently in your database.</p></div><hr><h4 ref=parseingredientsjobtest><code>ParseIngredientsJobTest</code></h4><a class=anchor id=parseingredientsjobtest></a><p>Let&rsquo;s write a test for <code>ParseIngredientsJob</code> to make sure that it&rsquo;s failsafe, in <code>app/Domains/Recipe/Tests/Jobs/ParseIngredientsJobTest</code>
which has already been created by <code>lucid</code> when generating the job. The test should cover three conditions:</p><ol><li>successful parsing</li><li>parsing empty string of ingredients</li><li>failsafe parsing with missing values</li></ol><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Domains\Recipe\Tests\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Data\Collections\IngredientsCollection</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Recipe\Jobs\ParseIngredientsJob</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>ParseIngredientsJobTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_parse_ingredients_job</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$input</span> <span class=o>=</span> <span class=s2>&#34;Avocado, 1, 1.2</span><span class=se>\r\n</span><span class=s2>Lettuce, 0.4, 0.8&#34;</span><span class=p>;</span>

        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ParseIngredientsJob</span><span class=p>(</span><span class=nv>$input</span><span class=p>);</span>

        <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertInstanceOf</span><span class=p>(</span><span class=nx>IngredientsCollection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=s1>&#39;Avocado&#39;</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>quantity</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>1.2</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>1.2</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>total</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=s1>&#39;Lettuce&#39;</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>0.4</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>quantity</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>0.8</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>0.32</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>total</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_parsing_empty_ingredients</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ParseIngredientsJob</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>);</span>

        <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertInstanceOf</span><span class=p>(</span><span class=nx>IngredientsCollection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertTrue</span><span class=p>(</span><span class=nv>$ingredients</span><span class=o>-&gt;</span><span class=na>isEmpty</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_failsafe_parsing_ingredients_with_missing_values</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$input</span> <span class=o>=</span> <span class=s2>&#34;Missing Price, 1</span><span class=se>\r\n</span><span class=s2>Only Title</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=p>;</span>

        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ParseIngredientsJob</span><span class=p>(</span><span class=nv>$input</span><span class=p>);</span>

        <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertInstanceOf</span><span class=p>(</span><span class=nx>IngredientsCollection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=o>-&gt;</span><span class=na>count</span><span class=p>());</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=s1>&#39;Missing Price&#39;</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>quantity</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>total</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=s1>&#39;Only Title&#39;</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>name</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>quantity</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nv>$ingredients</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-&gt;</span><span class=na>total</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><div class="notices secondary"><p><i class="fas fa-exclamation-triangle"></i> There is only one case where parsing fails with this implementation:
(i.e. <code>Avocado, ,2.5</code>) it is when skipping values. Consider it an exercise to improve the code! It was left out in this example to not complicate logic further.</p></div><p>For more on testing jobs visit <a href=https://docs.lucidarch.dev/jobs/#testing>jobs#testing</a>.</p><p>The tests for the rest of the jobs are available in the <a href=https://github.com/lucidarch/getting-started-monolith>source code</a>.</p><hr><h4 ref=calculaterecipeoperationtest><code>CalculateRecipeOperationTest</code></h4><a class=anchor id=calculaterecipeoperationtest></a><p>Testing operations is fairly similar and also fits among unit testing. We&rsquo;ll right the tests in the generated file
<code>app/Services/Kitchen/Tests/Operations/CalculateRecipeOperationTest</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Kitchen\Tests\Operations</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Services\Kitchen\Operations\CalculateRecipePriceOperation</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>CalculateRecipeOperationTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_calculate_recipe_operation</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$input</span> <span class=o>=</span> <span class=s2>&#34;Avocado, 1, 1.2</span><span class=se>\r\n</span><span class=s2>Lettuce, 0.4, 0.8&#34;</span><span class=p>;</span>

        <span class=nv>$op</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CalculateRecipePriceOperation</span><span class=p>(</span><span class=nv>$input</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>1.52</span><span class=p>,</span> <span class=nv>$op</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_calculating_empty_recipe_operation</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$op</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CalculateRecipePriceOperation</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=nv>$op</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>());</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_calculating_recipe_with_missing_values_operation</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$input</span> <span class=o>=</span> <span class=s2>&#34;Missing Price, 1</span><span class=se>\r\n</span><span class=s2>Only Title</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=p>;</span>

        <span class=nv>$op</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CalculateRecipePriceOperation</span><span class=p>(</span><span class=nv>$input</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertEquals</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=nv>$op</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>());</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>For more on testing operations visit <a href=https://docs.lucidarch.dev/operations/#testing>operations#testing</a></p><h3 ref=feature-test>Feature Test</h3><a class=anchor id=feature-test></a><p>The last test if the feature&rsquo;s behaviour with different input variations and make sure that all responses are as expected.
In principle, Lucid&rsquo;s feature tests are about testing the integration between the units that the feature runs (jobs and operations).</p><p>Starting with our test layout as a plan to what we will be examining and prepare the test class by including <code>RefreshDatabase</code> trait:</p><p><code>app/Services/Kitchen/Tests/Features/AddRecipeFeatureTest.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Services\Kitchen\Tests\Features</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Foundation\Testing\RefreshDatabase</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>AddRecipeFeatureTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>use</span> <span class=nx>RefreshDatabase</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_guest_cannot_submit_a_recipe</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>markTestIncomplete</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_recipe_is_not_created_if_validation_fails</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>markTestIncomplete</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_max_length_fails_when_too_long</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>markTestIncomplete</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_max_length_succeeds_when_under_max</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>markTestIncomplete</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Now we&rsquo;ll just fill the tests with corresponding calls and assertions:</p><p>We expect a guest to not be able to submit recipes since in our Request class <code>AddRecipe::authorize()</code> requires authorization:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>test_guest_cannot_submit_a_recipe</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$response</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/kitchen/recipes&#39;</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Avocado Salad Starter&#39;</span><span class=p>,</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=s2>&#34;Avocado, 1, 1.2</span><span class=se>\r\n</span><span class=s2>Lettuce, 0.4, 0.8&#34;</span><span class=p>,</span>
        <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Mix it with oil and enjoy!&#39;</span><span class=p>,</span>
    <span class=p>]);</span>

    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>assertStatus</span><span class=p>(</span><span class=mi>403</span><span class=p>);</span>
    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>assertSee</span><span class=p>(</span><span class=s1>&#39;This action is unauthorized.&#39;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Ensure input validation is as expected:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>test_recipe_is_not_created_if_validation_fails</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$response</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>actingAs</span><span class=p>(</span><span class=nx>User</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>create</span><span class=p>())</span><span class=o>-&gt;</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/kitchen/recipes&#39;</span><span class=p>);</span>

    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>assertSessionHasErrors</span><span class=p>([</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;ingredients&#39;</span><span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><p>Finally, test input strings lengths:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>test_max_length_fails_when_too_long</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$title</span> <span class=o>=</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>
    <span class=nv>$ingredients</span> <span class=o>=</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>
    <span class=nv>$instructions</span> <span class=o>=</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>

    <span class=nv>$user</span> <span class=o>=</span> <span class=nx>User</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>create</span><span class=p>();</span>
    <span class=nv>$response</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>actingAs</span><span class=p>(</span><span class=nv>$user</span><span class=p>)</span>
        <span class=o>-&gt;</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/kitchen/recipes&#39;</span><span class=p>,</span> <span class=nx>compact</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>,</span> <span class=s1>&#39;ingredients&#39;</span><span class=p>,</span> <span class=s1>&#39;instructions&#39;</span><span class=p>));</span>

    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>assertSessionHasErrors</span><span class=p>([</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;The title may not be greater than 255 characters.&#39;</span><span class=p>,</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;The ingredients may not be greater than 255 characters.&#39;</span><span class=p>,</span>
        <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;The instructions may not be greater than 255 characters.&#39;</span><span class=p>,</span>
    <span class=p>]);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>function</span> <span class=nf>test_max_length_succeeds_when_under_max</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>255</span><span class=p>),</span>
        <span class=s1>&#39;ingredients&#39;</span> <span class=o>=&gt;</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>255</span><span class=p>),</span>
        <span class=s1>&#39;instructions&#39;</span> <span class=o>=&gt;</span> <span class=nx>str_repeat</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=mi>255</span><span class=p>),</span>
    <span class=p>];</span>

    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>actingAs</span><span class=p>(</span><span class=nx>User</span><span class=o>::</span><span class=na>factory</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>create</span><span class=p>())</span><span class=o>-&gt;</span><span class=na>post</span><span class=p>(</span><span class=s1>&#39;/kitchen/recipes&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>

    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertDatabaseHas</span><span class=p>(</span><span class=s1>&#39;recipes&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h2 ref=conclusion>Conclusion</h2><a class=anchor id=conclusion></a><p>We&rsquo;ve covered a breadth of Lucid features with this exercise, however it only covered the <code>Kitchen</code> service.
We are left with the Forum service, which is similar in process to Kitchen, just different business logic.
For that reason we&rsquo;ll leave it to you to test your familiarity with the architecture, and the full source code
is present as a reference <i class="fab fa-github fa-lg"></i> <a href=https://github.com/lucidarch/getting-started-monolith>Getting Started - Monolith</a>.</p><h3 ref=highlights>Highlights</h3><a class=anchor id=highlights></a><ul><li><p>Application logic is segregated in services that makes it extremely simple to find corresponding logic when needed.</p></li><li><p>We are still using Laravel&rsquo;s internals and <code>artisan</code> for most of the things we did. This is intended to show how Lucid preserves
Laravel&rsquo;s defaults and avoids replicating or replacing them; in fact it complements them by elevating
their presence and fitting them within a defined structure.</p></li><li><p>Navigating services and their features couldn&rsquo;t get any easier, by looking at the <code>app/Services/*/Features</code> directory you&rsquo;d be able to have a summary of what
this application does at a glance.</p></li><li><p>Visiting a feature&rsquo;s class would also provide an overview of the steps required with the least
details possible, yet details are available when wanting to dig deeper.
In addition to the presence of tests that mirror these classes which makes it easy to update functionality with reduced unintentional negative impact.</p></li><li><p>Expanding on functionality such as <code>SaveRecipeJob</code> makes it easy to achieve a high degree of reusable code.
Consider updating a recipe, we&rsquo;d still use this job to save an existing recipe by supplying an optional <code>id</code> parameter and have the
job create or update accordingly.</p></li></ul></div><div class=chevrons><a class=next href=/micro-vs-monolith/ title="Micro • Monolith" style=margin-right:0><div><p>Next page</p><label>Micro • Monolith</label></div><i class="fas fa-arrow-right" style=font-size:1.7em></i></a></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/getting-started/monolith/>Monolith</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#setup>Setup</a><ul><li><a href=#install-laravel>Install Laravel</a></li><li><a href=#install-lucid>Install Lucid</a></li><li><a href=#database-configuration>Database Configuration</a></li></ul></li><li><a href=#initialize-monolith>Initialize Monolith</a></li><li><a href=#service-directory-structure>Service Directory Structure</a><ul><li><a href=#the-service-provider>The Service Provider</a></li></ul></li><li><a href=#authentication>Authentication</a></li><li><a href=#recipe-submission>Recipe Submission</a><ul><li><a href=#view>View</a></li><li><a href=#controller>Controller</a></li><li><a href=#feature>Feature</a></li><li><a href=#database>Database</a></li><li><a href=#model>Model</a></li><li><a href=#request-validation>Request Validation</a></li><li><a href=#calculate-recipe-price>Calculate Recipe Price</a></li><li><a href=#save-recipes>Save Recipes</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#configure-phpunit>Configure PHPUnit</a></li><li><a href=#unit-tests>Unit Tests</a></li><li><a href=#feature-test>Feature Test</a></li></ul></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#highlights>Highlights</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><i class="fas fa-calendar"></i>Last update on 04 December 2020</li><li><i class="fas fa-user"></i>Last update by Abed Halawi</li></ul></nav></div></section></article><footer><div class=columns><div class=column><div style=font-family:Raleway!important><h3 style=color:#fdfdfd!important>lucid architecture</h3>for a scalable future software</div></div><div class=column><div style=display:flex;justify-content:flex-end;align-items:center><div style=align-items:center;display:flex><a href=https://lucidarch.dev target=_blank><img src=/icon/lucid-coloured.png alt="Lucid website link" width=28px style=margin-top:4px></a>
<a href=https://github.com/lucidarch target=_blank style=margin-left:10px><i class="fab fa-github fa-lg"></i></a><a href=https://lucid-slack.herokuapp.com target=_blank style=margin-left:10px><i class="fab fa-slack fa-lg"></i></a><a href=https://www.reddit.com/r/lucidarch target=_blank style=margin-left:10px><i class="fab fa-reddit-alien fa-lg"></i></a></div><div style=margin-left:50px;margin-top:6px><a class=github-button href=https://github.com/sponsors/lucid-architecture data-icon=octicon-heart aria-label="Sponsor @lucid-architecture on GitHub">Sponsor</a>
<a class=github-button href=https://github.com/ntkme/github-buttons data-icon=octicon-star data-show-count=true aria-label="Star ntkme/github-buttons on GitHub">Star</a></div></div></div></div></footer></body></html>