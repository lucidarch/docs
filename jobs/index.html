<!doctype html><html><head><title>Jobs :: Lucid</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2020-12-30T18:33:06 UTC"><meta name=description content><title>Jobs :: Lucid</title><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/layout.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.main.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/css/style.menu.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://docs.lucidarch.dev/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/css/docport.css><script src=/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-96232175-1','auto');ga('send','pageview');}</script><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/site.webmanifest><script async defer src=https://buttons.github.io/buttons.js></script></head><body data-url=/jobs/ class=hideheader><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script><link href=/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/docs.lucidarch.dev";</script><script type=text/javascript src=/js/search.js></script></div><div style=margin-top:30px><a href=/concept style=display:flex;justify-content:left;align-items:center><img src=/icon/logo.png width=250 style=margin-left:10px></a></div><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><li data-nav-id=https://docs.lucidarch.dev/concept/ class="dd-item
alwaysopen
item_level_$level"><a href=/concept/>Concept</a></li><li data-nav-id=https://docs.lucidarch.dev/philosophy/ class="dd-item
alwaysopen
item_level_$level"><a href=/philosophy/>Philosophy</a></li><li data-nav-id=https://docs.lucidarch.dev/principles/ class="dd-item
alwaysopen
item_level_$level"><a href=/principles/>Principles</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/installation/ class="dd-item
alwaysopen
item_level_$level"><a href=/installation/>Installation</a></li><li data-nav-id=https://docs.lucidarch.dev/upgrade-guide/ class="dd-item
alwaysopen
item_level_$level"><a href=/upgrade-guide/>Upgrade Guide</a></li><li data-nav-id=https://docs.lucidarch.dev/getting-started/ class="dd-item
alwaysopen
item_level_$level"><a href=/getting-started/>Getting Started</a></li><li data-nav-id=https://docs.lucidarch.dev/micro-vs-monolith/ class="dd-item
alwaysopen
item_level_$level"><a href=/micro-vs-monolith/>Micro • Monolith</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/routing/ class="dd-item
alwaysopen
item_level_$level"><a href=/routing/>Routing</a></li><li data-nav-id=https://docs.lucidarch.dev/controllers/ class="dd-item
alwaysopen
item_level_$level"><a href=/controllers/>Controllers</a></li><li data-nav-id=https://docs.lucidarch.dev/features/ class="dd-item
alwaysopen
item_level_$level"><a href=/features/>Features</a></li><li data-nav-id=https://docs.lucidarch.dev/jobs/ class="dd-item parent active
alwaysopen
item_level_$level"><a href=/jobs/>Jobs</a></li><li data-nav-id=https://docs.lucidarch.dev/operations/ class="dd-item
alwaysopen
item_level_$level"><a href=/operations/>Operations</a></li><li data-nav-id=https://docs.lucidarch.dev/services/ class="dd-item
alwaysopen
item_level_$level"><a href=/services/>Services</a></li><li data-nav-id=https://docs.lucidarch.dev/domains/ class="dd-item
alwaysopen
item_level_$level"><a href=/domains/>Domains</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/validation/ class="dd-item
alwaysopen
item_level_$level"><a href=/validation/>Validation</a></li><hr><li data-nav-id=https://docs.lucidarch.dev/cli/ class="dd-item
alwaysopen
item_level_$level"><a href=/cli/>CLI Reference</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://docs.lucidarch.dev>Home</a></li><li class=active>Jobs</li></ol></nav><h1>Jobs</h1><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#jobs-in-domains>Jobs in Domains</a></li><li><a href=#characteristics>Characteristics</a></li><li><a href=#generate-job-class>Generate Job Class</a></li><li><a href=#calling-jobs>Calling Jobs</a></li><li><a href=#queuable-jobs>Queuable Jobs</a><ul><li><a href=#generate-queueable-job>Generate Queueable Job</a></li><li><a href=#specify-queue-name>Specify Queue Name</a></li></ul></li><li><a href=#custom-dispatcher>Custom Dispatcher</a></li><li><a href=#handling-errors-with-jobs>Handling Errors with Jobs</a><ul><li><a href=#rendering-exceptions>Rendering Exceptions</a></li><li><a href=#reportable--renderable-exceptions>Reportable & Renderable Exceptions</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#mocking>Mocking</a></li></ul></li></ul></nav></div><div class=content><p>Jobs do the actual work by implementing the business logic. Being the smallest unit in Lucid, a Job should do one thing, and one thing only -
that is: <strong>perform a single task</strong>.
They are the snippets of code we wish we had sometimes, and are pluggable to use anywhere in our application.</p><p>Our objective with Jobs is to limit the scope of a single functionality so that we know where to look when finding it,
and when we&rsquo;re within its context we don&rsquo;t tangle responsibility with other jobs to achieve the ultimate form of single responsibility principle.</p><p>Usually called by a Feature or an Operation, but can be called from anywhere by any other class once setup as a <a href=#custom-dispatcher>custom dispatcher</a>;
hence, being the most shareable pieces of code.</p><p><img src=/media/images/jobs/jobs-in-domains.png alt="Lucid Jobs in Domains"></p><h2 ref=jobs-in-domains>Jobs in Domains</h2><a class=anchor id=jobs-in-domains></a><p>Domains are where jobs live. It is how they&rsquo;re organized in the folder structure, and represent the execution point of a single functionality within the corresponding domain.
In other words, <strong>the only way to access a domain should be through a Job</strong>.</p><p>Here&rsquo;s an example of two domains (<code>User</code> & <code>Product</code>) exposing functionality through jobs.</p><ul><li><strong>User</strong> <em>[domain]</em><ul><li><code>LoginUserJob</code></li><li><code>LogoutUserJob</code></li><li><code>UpdateUserProfileJob</code></li></ul></li><li><strong>Product</strong> <em>[domain]</em><ul><li><code>FindProductByIDJob</code></li><li><code>SearchForProductJob</code></li><li><code>SaveProductDetailsJob</code></li><li><code>ValidateProductDetailsJob</code></li></ul></li></ul><p>Each of these is a class. Similar to other Lucid units it uses <code>__constructor</code> to define required parameters and is executed
through the <code>handle</code> method when calling <code>run</code>.</p><p><strong>Example</strong></p><p>In a Feature or Operation we can use <code>$this->run(ValidateProductDetailsJob::class)</code> to run the job&rsquo;s <code>handle</code> method.</p><p><code>app/Domains/Product/ValidateProductDetailsJob</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Product\ProductValidator</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>ValidateProductDetailsJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>array</span> <span class=nv>$input</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>__constructor</span><span class=p>(</span><span class=k>array</span> <span class=nv>$input</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>input</span> <span class=o>=</span> <span class=nv>$input</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=sd>/**
</span><span class=sd>     * @param  ProductValidator $validator
</span><span class=sd>     *
</span><span class=sd>     * @throws InvalidInputException
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>ProductValidator</span> <span class=nv>$validator</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$validator</span><span class=o>-&gt;</span><span class=na>validate</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>And in our feature: <code>.../Features/AddProductFeature.php</code></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>App\Domains\Http\Jobs\RespondWithJsonJob</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Product\Jobs\SaveProductDetailsJob</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\Product\Jobs\ValidateProductDetailsJob</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>AddProductFeature</span> <span class=k>extends</span> <span class=nx>Feature</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>Request</span> <span class=nv>$request</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>ValidateProductDetailsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;input&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(),</span>
        <span class=p>]);</span>

        <span class=nv>$product</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>SaveProductDetailsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
            <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>),</span>
            <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>),</span>
        <span class=p>]);</span>

        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>RespondWithJsonJob</span><span class=p>(</span><span class=nv>$product</span><span class=p>));</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2 ref=characteristics>Characteristics</h2><a class=anchor id=characteristics></a><ul><li>Unlike other units (feature & operation), <strong>jobs don&rsquo;t call other jobs</strong> to avoid obscure nested logic that end up being hard to follow and maintain.</li><li>Jobs do not know about other units, <strong>they operate in isolation</strong> and are unaware of their surroundings. If they were people,
they would&rsquo;ve been called selfish for only being concerned with themselves and their needs to perform their task.</li><li>Constructor parameters of a job - <em>a.k.a. job signature</em> - should be about the job itself only, not concerned with where it will be called from and in which conditions. Here&rsquo;s a personification of a Job speaking:<div class=card><div class=card-body><p class=card-text><p><em>I, as a Job, in order to fulfill my task, I need &ldquo;X&rdquo; and &ldquo;Y&rdquo;, and once I am done I will return &ldquo;Z&rdquo; to you.</em></p></p></div></div></li></ul><p>To validate your choice with jobs, simply ask yourself: <strong>&ldquo;what does this job do?"</strong> and the answer should be
<strong>&ldquo;It <em>[does this]</em> then returns <em>[that]</em>"</strong> where:</p><ul><li><em><strong>[does this]:</strong></em> should not include an &ldquo;and&rdquo; and should be made up of few words (single responsibility)</li><li><em><strong>[that]:</strong></em> ideally should either be an object, or a status response (boolean).<div class="notices info"><p>TIP: Avoid returning associative arrays as much as possible, or at all if possible. They ramp up undefined structures and it will require more cognitive load over time to figure out their structures and values.</p></div></li></ul><p>It is common practice to share jobs, in fact they are the units that are shared the most in code. For that reason
we strive to make their code cover the entire spectrum of the task they perform, while careful not to end up having complex jobs
just for the sake of reusing them.</p><p>Good balance between complexity and functionality is key with jobs, it gets better with time and the more you familiarize yourself with Lucid!</p><h2 ref=generate-job-class>Generate Job Class</h2><a class=anchor id=generate-job-class></a><p>Use <code>lucid</code> CLI to generate a Job class that extends Lucid&rsquo;s Job base class by default, which <code>handle</code> method is invoked when run by an Operation, Feature or a custom dispatcher.</p><div class=tabs><input type=radio name=tabs-2 id=tabs-2-0 checked>
<label for=tabs-2-0>Micro</label><div class=tab><p><strong>Signature</strong> <code>lucid make:job &lt;job> &lt;domain> {--Q|queue}</code></p><p><strong>Example</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job FindProduct product
</code></pre></div><p>Generated class will be at <code>app/Domains/Product/Jobs/FindProductJob.php</code></p><p>and its test at <code>tests/Domains/Product/Tests/FindProductJobTest.php</code></p></div><input type=radio name=tabs-2 id=tabs-2-1>
<label for=tabs-2-1>Monolith</label><div class=tab><p><strong>Signature</strong> <code>lucid make:job &lt;job> &lt;domain> {--Q|queue}</code></p><p><strong>Example</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash> lucid make:job FindProduct product
</code></pre></div><p>Generated class will be at <code>app/Domains/Product/Jobs/FindProductJob.php</code></p><p>and its test at <code>app/Domains/Product/Tests/FindProductJobTest.php</code></p></div></div><p>The generated Job class will automatically be suffixed with <code>Job</code>, so there&rsquo;s no need for it to be specified in the command.</p><div class="notices info"><p><i class="fas fa-asterisk"></i> For more details on this command see the help manual with <code>lucid make:job --help</code></p></div><h2 ref=calling-jobs>Calling Jobs</h2><a class=anchor id=calling-jobs></a><p>Jobs are called using the <code>run</code> method that&rsquo;s provided by extending one of Lucid&rsquo;s runner units <code>Feature</code> & <code>Operation</code> classes,
which internally relies on <code>UnitDispatcher</code> trait.</p><p><strong>Signature</strong></p><p><code>run($job, $arguments = [], $extra = [])</code></p><ul><li><code>$job</code> can be either a <code>Job</code> instance or the job&rsquo;s class name (usually using <code>SomeJob::class</code>)</li><li><code>[$arguments]</code> is the associative array of arguments mapping the Job&rsquo;s constructor parameters.
<strong>Only used when <code>$job</code> is the class name and not the instance.</strong></li><li>[<code>$extra</code>] is for the Laravel dispatcher and is not used by Lucid for any purposes, passed straight to the dispatcher.</li></ul><p><strong>Dispatching Jobs & Arguments <i class="fas fa-check-circle"></i></strong></p><p>Given this sample job that updates a product&rsquo;s info in the database:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Domains\Product\Jobs</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>UpdateProductDetailsJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$id</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$title</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$price</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$description</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span> <span class=o>=</span> <span class=nv>$id</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>title</span> <span class=o>=</span> <span class=nv>$title</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span> <span class=o>=</span> <span class=nv>$price</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>description</span> <span class=o>=</span> <span class=nv>$description</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span><span class=o>:</span> <span class=nx>bool</span>
    <span class=p>{</span>
        <span class=nv>$product</span> <span class=o>=</span> <span class=nx>Product</span><span class=o>::</span><span class=na>find</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>);</span>

        <span class=nv>$product</span><span class=o>-&gt;</span><span class=na>fill</span><span class=p>([</span>
            <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>title</span><span class=p>,</span>
            <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>price</span><span class=p>,</span>
            <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>description</span><span class=p>,</span>
        <span class=p>]);</span>

        <span class=k>return</span> <span class=nv>$product</span><span class=o>-&gt;</span><span class=na>save</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Calling this job from a feature or an operation is straight forward using <code>run()</code>:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>UpdateProductDetailsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>),</span>
    <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
    <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>),</span>
    <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>),</span>
<span class=p>]);</span>
</code></pre></div><p><code>$arguments</code> are sent as an associative array where the key should match parameters' names exactly, but not their order.
Meaning that we could tangle parameter order, reducing the amount of change required when updating the job with new order of arguments
or additional optional ones.</p><p>This would still work:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>UpdateProductDetailsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
    <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>),</span>
    <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>),</span>
    <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>),</span>
<span class=p>]);</span>
</code></pre></div><p>Also, aesthetically allows to organize parameters by length which is nicer to look at!</p><div class=card><div class=card-body><p class=card-text><p><i class="fas fa-check-circle"></i>This is the recommended way of calling jobs, for it makes <strong>reading run statements in features and operations explicit</strong>
and requires a <strong>reduced amount of knowledge</strong>, which preserves mental space for what actually matters.</p></p></div></div><p><strong>Dispatching Job Instances</strong></p><p>Given this simple job that retrieves a user from the DB by their identifier:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Domains\User\Jobs</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>GetUserJobID</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=nx>int</span> <span class=nv>$id</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>int</span> <span class=nv>$id</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span> <span class=o>=</span> <span class=nv>$id</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nx>User</span><span class=o>::</span><span class=na>find</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>We can simply initialize an instance and run it:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>GetUserByIDJob</span><span class=p>(</span><span class=nv>$userId</span><span class=p>));</span>
</code></pre></div><p>and it works exactly the same as if we did <code>run(GetUserByIDJob::class, ['id' => $userId])</code>.</p><div class="notices info"><p><i class="fas fa-exclamation-triangle"></i> <code>$arguments</code> won&rsquo;t apply when an initialized job is run.</p></div><p>Since the job requires only one argument, and looking at the <code>run</code> line is intuitively indicative of the intended functionality
and the argument, we can simply initialize the job ourselves and pass it to the dispatcher.</p><p>This is familiar with jobs that are known to (almost) never need to evolve beyond their initial functionality, and is surely
<strong>not recommended when the job requires two or more parameters</strong> because of the extra effort required to figure out the parameters
when reading run statements.</p><p>Take for the example the case of a job with more parameters:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=k>new</span> <span class=nx>UpdateProductDetailsJob</span><span class=p>(</span><span class=nv>$id</span><span class=p>,</span> <span class=nv>$title</span><span class=p>,</span> <span class=nv>$description</span><span class=p>,</span> <span class=nv>$price</span><span class=p>))</span>
</code></pre></div><p>instead of this:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>UpdateProductDetailsJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$id</span><span class=p>,</span>
    <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$title</span><span class=p>,</span>
    <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$description</span><span class=p>,</span>
    <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$price</span><span class=p>,</span>
<span class=p>])</span>
</code></pre></div><p><strong>Choosing Between Initialization & Separate Arguments</strong></p><p>As mentioned above, it is recommended to always call with arguments separately instead of initializing jobs externally,
because it makes code easier to read when there are multiple jobs in a sequence.</p><p>Here&rsquo;s a comparison of the two approaches in the following <code>handle</code> method, could be for a feature or an operation:</p><p><strong>Separate:</strong> A bit more writing but clearer when reading.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>Request</span> <span class=nv>$request</span><span class=p>)</span>
<span class=p>{</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>ValidateProductInputJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;input&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(),</span>
    <span class=p>]);</span>

    <span class=nv>$photos</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>UploadProductPicturesJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;cover&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;pictures.cover&#39;</span><span class=p>),</span>
        <span class=s1>&#39;showcase&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;pictures.showcase&#39;</span><span class=p>),</span>
    <span class=p>]);</span>

    <span class=nv>$product</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>CreateProductJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;title&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;title&#39;</span><span class=p>),</span>
        <span class=s1>&#39;price&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;price&#39;</span><span class=p>),</span>
        <span class=s1>&#39;description&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>),</span>
        <span class=s1>&#39;provider&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;provider&#39;</span><span class=p>),</span>
        <span class=s1>&#39;photos&#39;</span> <span class=o>=&gt;</span> <span class=nv>$photos</span>
    <span class=p>]);</span>

    <span class=nv>$isStockUpdated</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>UpdateProductStockAvailabilityJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$product</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>,</span>
        <span class=s1>&#39;available_count&#39;</span> <span class=o>=&gt;</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>input</span><span class=p>(</span><span class=s1>&#39;available_count&#39;</span><span class=p>),</span>
    <span class=p>]);</span>

    <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithViewJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
        <span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=nv>$product</span><span class=p>,</span>
        <span class=s1>&#39;template&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;product.update&#39;</span><span class=p>,</span>
    <span class=p>]);</span>
<span class=p>}</span>
</code></pre></div><p><strong>Initialized:</strong> Fast to write but harder to read.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>public <span class=k>function</span> handle<span class=o>(</span>Request <span class=nv>$request</span><span class=o>)</span>
<span class=o>{</span>
    <span class=nv>$this</span>-&gt;run<span class=o>(</span>new ValidateProductInputJob<span class=o>(</span><span class=nv>$request</span>-&gt;input<span class=o>))</span><span class=p>;</span>

    <span class=nv>$photos</span> <span class=o>=</span> <span class=nv>$this</span>-&gt;run<span class=o>(</span>new UploadProductPicturesJob<span class=o>(</span>
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;pictures.cover&#39;</span><span class=o>)</span>,
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;pictures.showcase&#39;</span><span class=o>))</span>
    <span class=o>)</span><span class=p>;</span>

    <span class=nv>$product</span> <span class=o>=</span> <span class=nv>$this</span>-&gt;run<span class=o>(</span>new CreateProductJob<span class=o>(</span>
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;title&#39;</span><span class=o>)</span>,
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;price&#39;</span><span class=o>)</span>,
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;description&#39;</span><span class=o>)</span>,
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;provider&#39;</span><span class=o>)</span>,
        <span class=nv>$photos</span><span class=o>)</span>
    <span class=o>)</span><span class=p>;</span>

    <span class=nv>$isStockUpdated</span> <span class=o>=</span> <span class=nv>$this</span>-&gt;run<span class=o>(</span>new UpdateProductStockAvailabilityJob<span class=o>(</span>
        <span class=nv>$product</span>-&gt;id,
        <span class=nv>$request</span>-&gt;input<span class=o>(</span><span class=s1>&#39;available_count&#39;</span><span class=o>))</span><span class=p>;</span>
<span class=o>}</span>
</code></pre></div><h2 ref=queuable-jobs>Queuable Jobs</h2><a class=anchor id=queuable-jobs></a><p>You may turn any job into a queueable job that will be dispatched using <a href=laravel.com/docs/queues>Laravel Queues</a> rather than running synchronously,
by simply implementing <code>ShouldQueue</code> interface.</p><h3 ref=generate-queueable-job>Generate Queueable Job</h3><a class=anchor id=generate-queueable-job></a><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job UploadPhotos files --queue
</code></pre></div><p>Will produce the following job class:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>class</span> <span class=nc>UploadPhotosJob</span> <span class=k>extends</span> <span class=nx>Job</span> <span class=k>implements</span> <span class=nx>ShouldQueue</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=c1>// photo uploads will be processed in the queue
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>This job will be treated exactly as Laravel treats <a href=https://laravel.com/docs/queues#class-structure>queued jobs</a>.</p><h3 ref=specify-queue-name>Specify Queue Name</h3><a class=anchor id=specify-queue-name></a><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>()</span>
<span class=p>{</span>
    <span class=cm>/*
</span><span class=cm>     * set the name of the queue on which to dispatch this job.
</span><span class=cm>     * if using Horizon, this should be the same as the one configured there.
</span><span class=cm>     */</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>onQueue</span><span class=p>(</span><span class=s1>&#39;emails&#39;</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><h2 ref=custom-dispatcher>Custom Dispatcher</h2><a class=anchor id=custom-dispatcher></a><p>You may turn any class in your application into a job dispatcher.
To equip a class for running jobs use <code>Lucid\Bus\UnitDispatcher</code> trait.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>Lucid\Bus\UnitDispatcher</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Handler</span> <span class=k>extends</span> <span class=nx>ExceptionHandler</span>
<span class=p>{</span>
    <span class=k>use</span> <span class=nx>UnitDispatcher</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>custom</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>TheJob</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h2 ref=handling-errors-with-jobs>Handling Errors with Jobs</h2><a class=anchor id=handling-errors-with-jobs></a><p>It is common to want to dispatch jobs from <code>Exceptions\Handler</code>,
where you may want to centralize your error responses in jobs to maintain a consistent structure across your application.</p><p>Assuming that we are working on an API where all our errors must be returned in JSON format, to avoid the accidental rendering
of an HTML page leading to unexpected behaviours. We would create a job to be run when encountering an exception that includes
the response structure. Lucid ships with one that can be used as default, available in the built-in <code>Http</code> domain <code>App\Domains\Http\Jobs\RespondWithJsonErrorJob</code> which has a simple signature:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithJobErrorJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
    <span class=s1>&#39;message&#39;</span> <span class=o>=&gt;</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>(),</span>
    <span class=s1>&#39;code&#39;</span> <span class=o>=&gt;</span> <span class=mi>2900</span><span class=p>,</span> <span class=c1>// custom error code, optional, default: 400
</span><span class=c1></span>    <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>400</span><span class=p>,</span> <span class=c1>// HTTP response status code, optional, default: 400
</span><span class=c1></span>    <span class=s1>&#39;headers&#39;</span> <span class=o>=&gt;</span> <span class=p>[],</span> <span class=c1>// customize headers
</span><span class=c1></span>    <span class=s1>&#39;options&#39;</span> <span class=o>=&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=c1>// will be passed to ResponseFactory::json()
</span><span class=c1></span><span class=p>]);</span>
</code></pre></div><p>Running this job in response to our exceptions will guarantee that the consumer always receives a consistent JSON structure:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>400</span><span class=p>,</span>
    <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>2900</span><span class=p>,</span>
        <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Expressive message about the error.&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 ref=rendering-exceptions>Rendering Exceptions</h3><a class=anchor id=rendering-exceptions></a><p>In our <code>Handler</code> class we can register a custom rendering Closure for exceptions of a given type and use the job to render JSON.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>App\Exceptions\CustomException</span><span class=p>;</span>

<span class=sd>/**
</span><span class=sd> * Register the exception handling callbacks for the application.
</span><span class=sd> *
</span><span class=sd> * @return void
</span><span class=sd> */</span>
<span class=k>public</span> <span class=k>function</span> <span class=nf>register</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>renderable</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>CustomException</span> <span class=nv>$e</span><span class=p>,</span> <span class=nv>$request</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithJsonErrorJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>500</span><span class=p>,</span>
            <span class=s1>&#39;message&#39;</span> <span class=o>=&gt;</span> <span class=nv>$e</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>(),</span>
        <span class=p>]);</span>
    <span class=p>});</span>
<span class=p>}</span>
</code></pre></div><p>You may also wish to return a view in the case of an HTML response instead:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>use</span> <span class=nx>App\Exceptions\CustomException</span><span class=p>;</span>

<span class=sd>/**
</span><span class=sd> * Register the exception handling callbacks for the application.
</span><span class=sd> *
</span><span class=sd> * @return void
</span><span class=sd> */</span>
<span class=k>public</span> <span class=k>function</span> <span class=nf>register</span><span class=p>()</span>
<span class=p>{</span>
    <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>renderable</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nx>CustomException</span> <span class=nv>$e</span><span class=p>,</span> <span class=nv>$request</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithViewJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>500</span><span class=p>,</span>
            <span class=s1>&#39;template&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;errors.custom&#39;</span><span class=p>,</span>
        <span class=p>]);</span>
    <span class=p>});</span>
<span class=p>}</span>
</code></pre></div><h3 ref=reportable--renderable-exceptions>Reportable & Renderable Exceptions</h3><a class=anchor id=reportable--renderable-exceptions></a><p>Similar to our <code>Handler</code> class, we may have our exceptions render themselves by defining <code>render</code> method in the exception class.</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Exceptions</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Exception</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Lucid\Bus\UnitDispatcher</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>RenderException</span> <span class=k>extends</span> <span class=nx>Exception</span>
<span class=p>{</span>
    <span class=k>use</span> <span class=nx>UnitDispatcher</span><span class=p>;</span>

    <span class=sd>/**
</span><span class=sd>     * Render the exception into an HTTP response.
</span><span class=sd>     *
</span><span class=sd>     * @param  \Illuminate\Http\Request  $request
</span><span class=sd>     * @return \Illuminate\Http\Response
</span><span class=sd>     */</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>render</span><span class=p>(</span><span class=nv>$request</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>(</span><span class=nx>RespondWithJsonErrorJob</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=p>[</span>
            <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=mi>500</span><span class=p>,</span>
            <span class=s1>&#39;message&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>(),</span>
        <span class=p>]);</span>
    <span class=p>}</span>
<span class=p>}</span>

</code></pre></div><h2 ref=testing>Testing</h2><a class=anchor id=testing></a><p>When generating a job with <code>lucid make:job</code> a test class is automatically generated along, having <code>markIncomplete()</code> statement
in a stub method as a reminder to fill the missing test.</p><p>Their locations help us encapsulate our domains since they would contain
all they need to operate in isolation.</p><div class=tabs><input type=radio name=tabs-7 id=tabs-7-0 checked>
<label for=tabs-7-0>Micro</label><div class=tab><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job UpdateProductDetails product
</code></pre></div><p>Would generate two files:</p><ul><li><code>app/Domains/Product/Jobs/UpdateProductDetailsJob</code></li><li><code>app/Domains/Product/Tests/Jobs/UpdateProductDetailsJobTest</code></li></ul></div><input type=radio name=tabs-7 id=tabs-7-1>
<label for=tabs-7-1>Monolith</label><div class=tab><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lucid make:job UpdateProductDetails product
</code></pre></div><p>Would generate two files:</p><ul><li><code>app/Domains/Product/Jobs/UpdateProductDetailsJob</code></li><li><code>app/Domains/Product/Tests/Jobs/UpdateProductDetailsJobTest</code></li></ul></div></div><p>The example below illustrates a simplified version of testing user input validation job:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Domains\User\Tests\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Lucid\Exceptions\InvalidInputException</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\User\Jobs\ValidateUserProfileInputJob</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>ValidateUserProfileInputJobTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_passes_validation</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$data</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s1>&#39;name&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;John Doe&#39;</span><span class=p>,</span>
            <span class=s1>&#39;email&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;john@example.com&#39;</span><span class=p>,</span>
            <span class=s1>&#39;occupation&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Fun Seeker&#39;</span><span class=p>,</span>
        <span class=p>];</span>

        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ValidateUserProfileInputJob</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span>

        <span class=nv>$isValid</span> <span class=o>=</span> <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertTrue</span><span class=p>(</span><span class=nv>$isValid</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_fails_with_empty_name</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>expectException</span><span class=p>(</span><span class=nx>InvalidInputException</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>expectExceptionMessage</span><span class=p>(</span><span class=s1>&#39;The name field is required.&#39;</span><span class=p>);</span>

        <span class=nv>$invalid</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s1>&#39;name&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
            <span class=s1>&#39;email&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;john@example.com&#39;</span><span class=p>,</span>
            <span class=s1>&#39;occupation&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;Fun Seeker&#39;</span><span class=p>,</span>
        <span class=p>];</span>

        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ValidateUserProfileInputJob</span><span class=p>(</span><span class=nv>$invalid</span><span class=p>);</span>

        <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h3 ref=mocking>Mocking</h3><a class=anchor id=mocking></a><p>In most cases you wouldn&rsquo;t want to mock with jobs because they are the actual units of work that need to be tested, though there
would still be cases where you must mock. E.g. fetching content from an external source as illustrated in the example below, where
we have a job to fetch articles from <a href=https://dev.to>dev.to</a> to test.</p><p>Our job looks like this:</p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Domains\DevTo\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Lucid\Units\Job</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\DevTo\Client</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Collection</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>FetchDevToArticlesJob</span> <span class=k>extends</span> <span class=nx>Job</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nx>Client</span> <span class=nv>$devto</span><span class=p>)</span><span class=o>:</span> <span class=nx>Collection</span>
    <span class=p>{</span>
        <span class=nv>$articles</span> <span class=o>=</span> <span class=nv>$devto</span><span class=o>-&gt;</span><span class=na>articles</span><span class=p>();</span>

        <span class=k>return</span> <span class=nx>collect</span><span class=p>(</span><span class=nv>$articles</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Client class code has been omitted, needless to say it is where the connection to dev.to happens to retrieve the articles:</p><p><strong>Test</strong></p><div class=highlight><pre class=chroma><code class=language-php data-lang=php><span class=k>namespace</span> <span class=nx>App\Domains\DevTo\Tests\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Mockery</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Tests\TestCase</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\DevTo\Client</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Collection</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>App\Domains\DevTo\Jobs\FetchDevToArticlesJob</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>FetchDevToArticlesJobTest</span> <span class=k>extends</span> <span class=nx>TestCase</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>test_fetch_dev_to_articles_job</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nv>$expected</span> <span class=o>=</span> <span class=nx>json_encode</span><span class=p>([</span>
            <span class=s1>&#39;expected&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;response&#39;</span><span class=p>,</span>
            <span class=s1>&#39;goes&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;here&#39;</span><span class=p>,</span>
        <span class=p>],</span> <span class=k>true</span><span class=p>);</span>

        <span class=c1>// mock client
</span><span class=c1></span>        <span class=nv>$mClient</span> <span class=o>=</span> <span class=nx>Mockery</span><span class=o>::</span><span class=na>mock</span><span class=p>(</span><span class=nx>Client</span><span class=o>::</span><span class=na>class</span><span class=p>);</span>
        <span class=nv>$mClient</span><span class=o>-&gt;</span><span class=na>shouldReceive</span><span class=p>(</span><span class=s1>&#39;articles&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>withNoArgs</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>andReturn</span><span class=p>(</span><span class=nv>$expected</span><span class=p>);</span>

        <span class=nv>$job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FetchDevToArticlesJob</span><span class=p>();</span>

        <span class=c1>// execute job with injected mocked client
</span><span class=c1></span>        <span class=nv>$articles</span> <span class=o>=</span> <span class=nv>$job</span><span class=o>-&gt;</span><span class=na>handle</span><span class=p>(</span><span class=nv>$mClient</span><span class=p>);</span>

        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>assertInstanceOf</span><span class=p>(</span><span class=nx>Collection</span><span class=o>::</span><span class=na>class</span><span class=p>,</span> <span class=nv>$articles</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div></div><div class=chevrons><a class=next href=/operations/ title=Operations style=margin-right:0><div><p>Next page</p><label>Operations</label></div><i class="fas fa-arrow-right" style=font-size:1.7em></i></a></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/jobs/>Jobs</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#jobs-in-domains>Jobs in Domains</a></li><li><a href=#characteristics>Characteristics</a></li><li><a href=#generate-job-class>Generate Job Class</a></li><li><a href=#calling-jobs>Calling Jobs</a></li><li><a href=#queuable-jobs>Queuable Jobs</a><ul><li><a href=#generate-queueable-job>Generate Queueable Job</a></li><li><a href=#specify-queue-name>Specify Queue Name</a></li></ul></li><li><a href=#custom-dispatcher>Custom Dispatcher</a></li><li><a href=#handling-errors-with-jobs>Handling Errors with Jobs</a><ul><li><a href=#rendering-exceptions>Rendering Exceptions</a></li><li><a href=#reportable--renderable-exceptions>Reportable & Renderable Exceptions</a></li></ul></li><li><a href=#testing>Testing</a><ul><li><a href=#mocking>Mocking</a></li></ul></li></ul></nav></div><div class=Actions><nav><ul><li><i class="fas fa-calendar"></i>Last update on 30 December 2020</li><li><i class="fas fa-user"></i>Last update by Abed Halawi</li></ul></nav></div></section></article><footer><div class=columns><div class=column><div style=font-family:Raleway!important><h3 style=color:#fdfdfd!important>lucid architecture</h3>for a scalable future software</div></div><div class=column><div style=display:flex;justify-content:flex-end;align-items:center><div style=align-items:center;display:flex><a href=https://lucidarch.dev target=_blank><img src=/icon/lucid-coloured.png alt="Lucid website link" width=28px style=margin-top:4px></a>
<a href=https://github.com/lucidarch target=_blank style=margin-left:10px><i class="fab fa-github fa-lg"></i></a><a href=https://lucid-slack.herokuapp.com target=_blank style=margin-left:10px><i class="fab fa-slack fa-lg"></i></a><a href=https://www.reddit.com/r/lucidarch target=_blank style=margin-left:10px><i class="fab fa-reddit-alien fa-lg"></i></a></div><div style=margin-left:50px;margin-top:6px><a class=github-button href=https://github.com/sponsors/lucid-architecture data-icon=octicon-heart aria-label="Sponsor @lucid-architecture on GitHub">Sponsor</a>
<a class=github-button href=https://github.com/ntkme/github-buttons data-icon=octicon-star data-show-count=true aria-label="Star ntkme/github-buttons on GitHub">Star</a></div></div></div></div></footer></body></html>